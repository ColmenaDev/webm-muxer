"use strict";var WebMMuxer=(()=>{var dt=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames,vt=Object.getOwnPropertySymbols;var Wt=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var b=Math.pow,Ht=(a,t,i)=>t in a?dt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):a[t]=i,Kt=(a,t)=>{for(var i in t||={})Wt.call(t,i)&&Ht(a,i,t[i]);if(vt)for(var i of vt(t))le.call(t,i)&&Ht(a,i,t[i]);return a};var de=(a,t)=>{for(var i in t)dt(a,i,{get:t[i],enumerable:!0})},fe=(a,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of oe(t))!Wt.call(a,r)&&r!==i&&dt(a,r,{get:()=>t[r],enumerable:!(s=he(t,r))||s.enumerable});return a};var ue=a=>fe(dt({},"__esModule",{value:!0}),a);var zt=(a,t,i)=>{if(!t.has(a))throw TypeError("Cannot "+i)};var e=(a,t,i)=>(zt(a,t,"read from private field"),i?i.call(a):t.get(a)),h=(a,t,i)=>{if(t.has(a))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(a):t.set(a,i)},m=(a,t,i,s)=>(zt(a,t,"write to private field"),s?s.call(a,i):t.set(a,i),i);var d=(a,t,i)=>(zt(a,t,"access private method"),i);var ke={};de(ke,{default:()=>ye});var _=class{constructor(t){this.value=t}},S=class{constructor(t){this.value=t}};var Vt=a=>a<1<<8?1:a<1<<16?2:a<1<<24?3:a<b(2,32)?4:a<b(2,40)?5:6,$t=a=>{if(a<(1<<7)-1)return 1;if(a<(1<<14)-1)return 2;if(a<(1<<21)-1)return 3;if(a<(1<<28)-1)return 4;if(a<b(2,35)-1)return 5;if(a<b(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+a)};var x,f,ft,Bt,ut,Yt,it,Dt,mt,Zt,I=class{constructor(){h(this,ft);h(this,ut);h(this,it);h(this,mt);this.pos=0;h(this,x,new Uint8Array(8));h(this,f,new DataView(e(this,x).buffer));this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeEBMLVarInt(t,i=$t(t)){let s=0;switch(i){case 1:e(this,f).setUint8(s++,1<<7|t);break;case 2:e(this,f).setUint8(s++,1<<6|t>>8),e(this,f).setUint8(s++,t);break;case 3:e(this,f).setUint8(s++,1<<5|t>>16),e(this,f).setUint8(s++,t>>8),e(this,f).setUint8(s++,t);break;case 4:e(this,f).setUint8(s++,1<<4|t>>24),e(this,f).setUint8(s++,t>>16),e(this,f).setUint8(s++,t>>8),e(this,f).setUint8(s++,t);break;case 5:e(this,f).setUint8(s++,1<<3|t/b(2,32)&7),e(this,f).setUint8(s++,t>>24),e(this,f).setUint8(s++,t>>16),e(this,f).setUint8(s++,t>>8),e(this,f).setUint8(s++,t);break;case 6:e(this,f).setUint8(s++,1<<2|t/b(2,40)&3),e(this,f).setUint8(s++,t/b(2,32)|0),e(this,f).setUint8(s++,t>>24),e(this,f).setUint8(s++,t>>16),e(this,f).setUint8(s++,t>>8),e(this,f).setUint8(s++,t);break;default:throw new Error("Bad EBML VINT size "+i)}this.write(e(this,x).subarray(0,s))}writeEBML(t){var i,s;if(t instanceof Uint8Array)this.write(t);else if(Array.isArray(t))for(let r of t)this.writeEBML(r);else if(this.offsets.set(t,this.pos),d(this,it,Dt).call(this,t.id),Array.isArray(t.data)){let r=this.pos,n=(i=t.size)!=null?i:4;this.seek(this.pos+n);let l=this.pos;this.dataOffsets.set(t,l),this.writeEBML(t.data);let u=this.pos-l,J=this.pos;this.seek(r),this.writeEBMLVarInt(u,n),this.seek(J)}else if(typeof t.data=="number"){let r=(s=t.size)!=null?s:Vt(t.data);this.writeEBMLVarInt(r),d(this,it,Dt).call(this,t.data,r)}else typeof t.data=="string"?(this.writeEBMLVarInt(t.data.length),d(this,mt,Zt).call(this,t.data)):t.data instanceof Uint8Array?(this.writeEBMLVarInt(t.data.byteLength,t.size),this.write(t.data)):t.data instanceof _?(this.writeEBMLVarInt(4),d(this,ft,Bt).call(this,t.data.value)):t.data instanceof S&&(this.writeEBMLVarInt(8),d(this,ut,Yt).call(this,t.data.value))}};x=new WeakMap,f=new WeakMap,ft=new WeakSet,Bt=function(t){e(this,f).setFloat32(0,t,!1),this.write(e(this,x).subarray(0,4))},ut=new WeakSet,Yt=function(t){e(this,f).setFloat64(0,t,!1),this.write(e(this,x))},it=new WeakSet,Dt=function(t,i=Vt(t)){let s=0;switch(i){case 6:e(this,f).setUint8(s++,t/b(2,40)|0);case 5:e(this,f).setUint8(s++,t/b(2,32)|0);case 4:e(this,f).setUint8(s++,t>>24);case 3:e(this,f).setUint8(s++,t>>16);case 2:e(this,f).setUint8(s++,t>>8);case 1:e(this,f).setUint8(s++,t);break;default:throw new Error("Bad UINT size "+i)}this.write(e(this,x).subarray(0,s))},mt=new WeakSet,Zt=function(t){this.write(new Uint8Array(t.split("").map(i=>i.charCodeAt(0))))};var T,N,tt=class extends I{constructor(){super();h(this,T,new ArrayBuffer(b(2,16)));h(this,N,new Uint8Array(e(this,T)))}ensureSize(i){let s=e(this,T).byteLength;for(;s<i;)s*=2;if(s===e(this,T).byteLength)return;let r=new ArrayBuffer(s),n=new Uint8Array(r);n.set(e(this,N),0),m(this,T,r),m(this,N,n)}write(i){this.ensureSize(this.pos+i.byteLength),e(this,N).set(i,this.pos),this.pos+=i.byteLength}seek(i){this.pos=i}finalize(){return this.ensureSize(this.pos),e(this,T).slice(0,this.pos)}};T=new WeakMap,N=new WeakMap;var M=b(2,24),me=2,st,p,et=class extends I{constructor(i){super();h(this,st,void 0);h(this,p,[]);m(this,st,i)}write(i){this.writeDataIntoChunks(i,this.pos),this.flushChunks(),this.pos+=i.byteLength}writeDataIntoChunks(i,s){let r=e(this,p).findIndex(R=>R.start<=s&&s<R.start+M);r===-1&&(r=this.createChunk(s));let n=e(this,p)[r],l=s-n.start,u=i.subarray(0,Math.min(M-l,i.byteLength));n.data.set(u,l);let J={start:l,end:l+u.byteLength};if(ce(n,J),n.written[0].start===0&&n.written[0].end===M&&(n.shouldFlush=!0),e(this,p).length>me){for(let R=0;R<e(this,p).length-1;R++)e(this,p)[R].shouldFlush=!0;this.flushChunks()}u.byteLength<i.byteLength&&this.writeDataIntoChunks(i.subarray(u.byteLength),s+u.byteLength)}createChunk(i){let r={start:Math.floor(i/M)*M,data:new Uint8Array(M),written:[],shouldFlush:!1};return e(this,p).push(r),e(this,p).sort((n,l)=>n.start-l.start),e(this,p).indexOf(r)}flushChunks(i=!1){for(let s=0;s<e(this,p).length;s++){let r=e(this,p)[s];if(!(!r.shouldFlush&&!i)){for(let n of r.written)e(this,st).write({type:"write",data:r.data.subarray(n.start,n.end),position:r.start+n.start});e(this,p).splice(s--,1)}}}seek(i){this.pos=i}finalize(){this.flushChunks(!0)}};st=new WeakMap,p=new WeakMap;var ce=(a,t)=>{let i=0,s=a.written.length-1,r=-1;for(;i<=s;){let n=Math.floor(i+(s-i+1)/2);a.written[n].start<=t.start?(i=n+1,r=n):s=n-1}for(a.written.splice(r+1,0,t),(r===-1||a.written[r].end<t.start)&&r++;r<a.written.length-1&&a.written[r].end>=a.written[r+1].start;)a.written[r].end=Math.max(a.written[r].end,a.written[r+1].end),a.written.splice(r+1,1)},U,rt,O=class extends I{constructor(i){super();h(this,U,[]);h(this,rt,void 0);m(this,rt,i)}write(i){e(this,U).push({data:i.slice(),start:this.pos}),this.pos+=i.byteLength}seek(i){this.pos=i}flush(i){if(e(this,U).length===0)return;let s=[],r=[...e(this,U)].sort((n,l)=>n.start-l.start);s.push({start:r[0].start,size:r[0].data.byteLength});for(let n=1;n<r.length;n++){let l=s[s.length-1],u=r[n];u.start<=l.start+l.size?l.size=Math.max(l.size,u.start+u.data.byteLength-l.start):s.push({start:u.start,size:u.data.byteLength})}for(let n of s){n.data=new Uint8Array(n.size);for(let u of e(this,U))n.start<=u.start&&u.start<n.start+n.size&&n.data.set(u.data,u.start-n.start);let l=i&&n===s[s.length-1];e(this,rt).call(this,n.data,n.start,l)}e(this,U).length=0}};U=new WeakMap,rt=new WeakMap;var z=1,Ft=2,be=1,pe=2,Pt=b(2,15),Et=b(2,12),Lt="https://github.com/Vanilagy/webm-muxer",Xt=6,qt=5,we=["strict","offset","permissive"],o,c,W,K,w,$,D,F,B,Y,P,y,E,Z,g,k,L,X,q,G,Q,at,bt,Gt,pt,Qt,wt,jt,yt,Jt,gt,It,kt,te,Ct,ee,xt,ie,j,ct,A,H,Tt,se,Ut,re,nt,_t,At,ae,C,V,ht,Mt,St,ne,ot,Nt,lt,Ot,Rt=class{constructor(t){h(this,bt);h(this,pt);h(this,wt);h(this,yt);h(this,gt);h(this,kt);h(this,Ct);h(this,xt);h(this,j);h(this,A);h(this,Tt);h(this,Ut);h(this,nt);h(this,At);h(this,C);h(this,ht);h(this,St);h(this,ot);h(this,lt);h(this,o,void 0);h(this,c,void 0);h(this,W,void 0);h(this,K,void 0);h(this,w,void 0);h(this,$,void 0);h(this,D,void 0);h(this,F,void 0);h(this,B,void 0);h(this,Y,void 0);h(this,P,void 0);h(this,y,void 0);h(this,E,void 0);h(this,Z,0);h(this,g,[]);h(this,k,[]);h(this,L,void 0);h(this,X,void 0);h(this,q,-1);h(this,G,-1);h(this,Q,void 0);h(this,at,!1);if(d(this,bt,Gt).call(this,t),m(this,c,Kt({type:"webm",firstTimestampBehavior:"strict"},t)),t.target==="buffer")m(this,o,new tt);else if(t.target instanceof FileSystemWritableFileStream)m(this,o,new et(t.target));else if(typeof t.target=="function")m(this,o,new O(t.target));else throw new Error(`Invalid target: ${t.target}`);d(this,pt,Qt).call(this)}addVideoChunk(t,i,s){let r=new Uint8Array(t.byteLength);t.copyTo(r),this.addVideoChunkRaw(r,t.type,s!=null?s:t.timestamp,i)}addVideoChunkRaw(t,i,s,r){if(d(this,lt,Ot).call(this),!e(this,c).video)throw new Error("No video track declared.");e(this,L)===void 0&&m(this,L,s),r&&d(this,Tt,se).call(this,r);let n=d(this,nt,_t).call(this,t,i,s,z);for(e(this,c).video.codec==="V_VP9"&&d(this,Ut,re).call(this,n),m(this,q,n.timestamp);e(this,k).length>0&&e(this,k)[0].timestamp<=n.timestamp;){let l=e(this,k).shift();d(this,C,V).call(this,l)}!e(this,c).audio||n.timestamp<=e(this,G)?d(this,C,V).call(this,n):e(this,g).push(n),d(this,j,ct).call(this)}addAudioChunk(t,i,s){let r=new Uint8Array(t.byteLength);t.copyTo(r),this.addAudioChunkRaw(r,t.type,s!=null?s:t.timestamp,i)}addAudioChunkRaw(t,i,s,r){if(d(this,lt,Ot).call(this),!e(this,c).audio)throw new Error("No audio track declared.");e(this,X)===void 0&&m(this,X,s);let n=d(this,nt,_t).call(this,t,i,s,Ft);for(m(this,G,n.timestamp);e(this,g).length>0&&e(this,g)[0].timestamp<=n.timestamp;){let l=e(this,g).shift();d(this,C,V).call(this,l)}!e(this,c).video||n.timestamp<=e(this,q)?d(this,C,V).call(this,n):e(this,k).push(n),r!=null&&r.decoderConfig&&d(this,ht,Mt).call(this,e(this,Y),r.decoderConfig.description),d(this,j,ct).call(this)}finalize(){for(;e(this,g).length>0;)d(this,C,V).call(this,e(this,g).shift());for(;e(this,k).length>0;)d(this,C,V).call(this,e(this,k).shift());d(this,ot,Nt).call(this),e(this,o).writeEBML(e(this,P));let t=e(this,o).pos,i=e(this,o).pos-e(this,A,H);return e(this,o).seek(e(this,o).offsets.get(e(this,W))+4),e(this,o).writeEBMLVarInt(i,Xt),e(this,D).data=new S(e(this,Z)),e(this,o).seek(e(this,o).offsets.get(e(this,D))),e(this,o).writeEBML(e(this,D)),e(this,w).data[0].data[1].data=e(this,o).offsets.get(e(this,P))-e(this,A,H),e(this,w).data[1].data[1].data=e(this,o).offsets.get(e(this,K))-e(this,A,H),e(this,w).data[2].data[1].data=e(this,o).offsets.get(e(this,$))-e(this,A,H),e(this,o).seek(e(this,o).offsets.get(e(this,w))),e(this,o).writeEBML(e(this,w)),e(this,o).seek(t),m(this,at,!0),e(this,o)instanceof tt?e(this,o).finalize():(e(this,o)instanceof et?e(this,o).finalize():e(this,o)instanceof O&&e(this,o).flush(!0),null)}};o=new WeakMap,c=new WeakMap,W=new WeakMap,K=new WeakMap,w=new WeakMap,$=new WeakMap,D=new WeakMap,F=new WeakMap,B=new WeakMap,Y=new WeakMap,P=new WeakMap,y=new WeakMap,E=new WeakMap,Z=new WeakMap,g=new WeakMap,k=new WeakMap,L=new WeakMap,X=new WeakMap,q=new WeakMap,G=new WeakMap,Q=new WeakMap,at=new WeakMap,bt=new WeakSet,Gt=function(t){if(t.type&&t.type!=="webm"&&t.type!=="matroska")throw new Error(`Invalid type: ${t.type}`);if(t.firstTimestampBehavior&&!we.includes(t.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${t.firstTimestampBehavior}`)},pt=new WeakSet,Qt=function(){d(this,wt,jt).call(this),d(this,yt,Jt).call(this),d(this,gt,It).call(this),d(this,kt,te).call(this),d(this,Ct,ee).call(this),d(this,xt,ie).call(this),d(this,j,ct).call(this)},wt=new WeakSet,jt=function(){var i;let t={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:(i=e(this,c).type)!=null?i:"webm"},{id:17031,data:2},{id:17029,data:2}]};e(this,o).writeEBML(t)},yt=new WeakSet,Jt=function(){let t=new Uint8Array([28,83,187,107]),i=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]};m(this,w,r)},gt=new WeakSet,It=function(){let t={id:17545,data:new S(0)};m(this,D,t);let i={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Lt},{id:22337,data:Lt},t]};m(this,K,i)},kt=new WeakSet,te=function(){let t={id:374648427,data:[]};if(m(this,$,t),e(this,c).video){m(this,B,{id:236,size:4,data:new Uint8Array(Et)});let i={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};m(this,F,i),t.data.push({id:174,data:[{id:215,data:z},{id:29637,data:z},{id:131,data:be},{id:134,data:e(this,c).video.codec},e(this,B),e(this,c).video.frameRate?{id:2352003,data:1e9/e(this,c).video.frameRate}:null,{id:224,data:[{id:176,data:e(this,c).video.width},{id:186,data:e(this,c).video.height},i]}].filter(Boolean)})}e(this,c).audio&&(m(this,Y,{id:236,size:4,data:new Uint8Array(Et)}),t.data.push({id:174,data:[{id:215,data:Ft},{id:29637,data:Ft},{id:131,data:pe},{id:134,data:e(this,c).audio.codec},e(this,Y),{id:225,data:[{id:181,data:new _(e(this,c).audio.sampleRate)},{id:159,data:e(this,c).audio.numberOfChannels},e(this,c).audio.bitDepth?{id:25188,data:e(this,c).audio.bitDepth}:null].filter(Boolean)}]}))},Ct=new WeakSet,ee=function(){let t={id:408125543,size:Xt,data:[e(this,w),e(this,K),e(this,$)]};m(this,W,t),e(this,o).writeEBML(t)},xt=new WeakSet,ie=function(){m(this,P,{id:475249515,data:[]})},j=new WeakSet,ct=function(){e(this,o)instanceof O&&e(this,o).flush(!1)},A=new WeakSet,H=function(){return e(this,o).dataOffsets.get(e(this,W))},Tt=new WeakSet,se=function(t){if(t.decoderConfig){if(t.decoderConfig.colorSpace){let i=t.decoderConfig.colorSpace;m(this,Q,i),e(this,F).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[i.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[i.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[i.primaries]},{id:21945,data:[1,2][Number(i.fullRange)]}];let s=e(this,o).pos;e(this,o).seek(e(this,o).offsets.get(e(this,F))),e(this,o).writeEBML(e(this,F)),e(this,o).seek(s)}t.decoderConfig.description&&d(this,ht,Mt).call(this,e(this,B),t.decoderConfig.description)}},Ut=new WeakSet,re=function(t){if(t.type!=="key"||!e(this,Q))return;let i=0;if(v(t.data,0,2)!==2)return;i+=2;let s=(v(t.data,i+1,i+2)<<1)+v(t.data,i+0,i+1);i+=2,s===3&&i++;let r=v(t.data,i+0,i+1);if(i++,r)return;let n=v(t.data,i+0,i+1);if(i++,n!==0)return;i+=2;let l=v(t.data,i+0,i+24);if(i+=24,l!==4817730)return;s>=2&&i++;let u={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e(this,Q).matrix];ge(t.data,i+0,i+3,u)},nt=new WeakSet,_t=function(t,i,s,r){let n=d(this,At,ae).call(this,s,r);return{data:t,type:i,timestamp:n,trackNumber:r}},At=new WeakSet,ae=function(t,i){let s=i===z?e(this,L):e(this,X),r=i===z?e(this,q):e(this,G);if(e(this,c).firstTimestampBehavior==="strict"&&r===-1&&t!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${t}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
If you want to allow non-zero first timestamps, set firstTimestampBehavior: 'permissive'.
`);if(e(this,c).firstTimestampBehavior==="offset"&&(t-=s),t<r)throw new Error(`Timestamps must be monotonically increasing (went from ${r} to ${t}).`);return t},C=new WeakSet,V=function(t){let i=Math.floor(t.timestamp/1e3);if(t.type!=="key"&&i-e(this,E)>=Pt)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${Pt} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${Pt} milliseconds.`);let r=(t.trackNumber===z||!e(this,c).video)&&t.type==="key"&&i-e(this,E)>=1e3;(!e(this,y)||r)&&d(this,St,ne).call(this,i);let n=new Uint8Array(4),l=new DataView(n.buffer);l.setUint8(0,128|t.trackNumber),l.setUint16(1,i-e(this,E),!1),l.setUint8(3,Number(t.type==="key")<<7);let u={id:163,data:[n,t.data]};e(this,o).writeEBML(u),m(this,Z,Math.max(e(this,Z),i))},ht=new WeakSet,Mt=function(t,i){let s=e(this,o).pos;e(this,o).seek(e(this,o).offsets.get(t)),t=[{id:25506,size:4,data:new Uint8Array(i)},{id:236,size:4,data:new Uint8Array(Et-2-4-i.byteLength)}],e(this,o).writeEBML(t),e(this,o).seek(s)},St=new WeakSet,ne=function(t){e(this,y)&&d(this,ot,Nt).call(this),m(this,y,{id:524531317,size:qt,data:[{id:231,data:t}]}),e(this,o).writeEBML(e(this,y)),m(this,E,t);let i=e(this,o).offsets.get(e(this,y))-e(this,A,H);e(this,P).data.push({id:187,data:[{id:179,data:t},{id:183,data:[{id:247,data:z},{id:241,data:i}]}]})},ot=new WeakSet,Nt=function(){let t=e(this,o).pos-e(this,o).dataOffsets.get(e(this,y)),i=e(this,o).pos;e(this,o).seek(e(this,o).offsets.get(e(this,y))+4),e(this,o).writeEBMLVarInt(t,qt),e(this,o).seek(i)},lt=new WeakSet,Ot=function(){if(e(this,at))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var ye=Rt,v=(a,t,i)=>{let s=0;for(let r=t;r<i;r++){let n=Math.floor(r/8),l=a[n],u=7-(r&7),J=(l&1<<u)>>u;s<<=1,s|=J}return s},ge=(a,t,i,s)=>{for(let r=t;r<i;r++){let n=Math.floor(r/8),l=a[n],u=7-(r&7);l&=~(1<<u),l|=(s&1<<i-r-1)>>i-r-1<<u,a[n]=l}};return ue(ke);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
