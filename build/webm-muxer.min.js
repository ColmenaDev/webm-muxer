"use strict";var WebMMuxer=(()=>{var b=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var h=Math.pow;var z=(r,e)=>{for(var t in e)b(r,t,{get:e[t],enumerable:!0})},P=(r,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of D(e))!v.call(r,s)&&s!==t&&b(r,s,{get:()=>e[s],enumerable:!(i=A(e,s))||i.enumerable});return r};var F=r=>P(b({},"__esModule",{value:!0}),r);var Q={};z(Q,{default:()=>R});var d=class{constructor(e){this.value=e}},u=class{constructor(e){this.value=e}};var w=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=S(e)){let i=0;switch(t){case 6:this.helperView.setUint8(i++,e/h(2,40)|0);case 5:this.helperView.setUint8(i++,e/h(2,32)|0);case 4:this.helperView.setUint8(i++,e>>24);case 3:this.helperView.setUint8(i++,e>>16);case 2:this.helperView.setUint8(i++,e>>8);case 1:this.helperView.setUint8(i++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,i))}writeEBMLVarInt(e,t=E(e)){let i=0;switch(t){case 1:this.helperView.setUint8(i++,1<<7|e);break;case 2:this.helperView.setUint8(i++,1<<6|e>>8),this.helperView.setUint8(i++,e);break;case 3:this.helperView.setUint8(i++,1<<5|e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 4:this.helperView.setUint8(i++,1<<4|e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 5:this.helperView.setUint8(i++,1<<3|e/h(2,32)&7),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 6:this.helperView.setUint8(i++,1<<2|e/h(2,40)&3),this.helperView.setUint8(i++,e/h(2,32)|0),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,i))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t,i;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let s of e)this.writeEBML(s);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let s=this.pos,a=(t=e.size)!=null?t:4;this.seek(this.pos+a);let n=this.pos;this.dataOffsets.set(e,n),this.writeEBML(e.data);let o=this.pos-n,g=this.pos;this.seek(s),this.writeEBMLVarInt(o,a),this.seek(g)}else if(typeof e.data=="number"){let s=(i=e.size)!=null?i:S(e.data);this.writeEBMLVarInt(s),this.writeUnsignedInt(e.data,s)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof d?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof u&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},S=r=>r<1<<8?1:r<1<<16?2:r<1<<24?3:r<h(2,32)?4:r<h(2,40)?5:6,E=r=>{if(r<(1<<7)-1)return 1;if(r<(1<<14)-1)return 2;if(r<(1<<21)-1)return 3;if(r<(1<<28)-1)return 4;if(r<h(2,35)-1)return 5;if(r<h(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+r)},f=class extends w{constructor(){super();this.buffer=new ArrayBuffer(h(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let i=this.buffer.byteLength;for(;i<t;)i*=2;if(i===this.buffer.byteLength)return;let s=new ArrayBuffer(i),a=new Uint8Array(s);a.set(this.bytes,0),this.buffer=s,this.bytes=a}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},c=h(2,24),N=2,p=class extends w{constructor(t){super();this.chunks=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,i){let s=this.chunks.findIndex(l=>l.start<=i&&i<l.start+c);s===-1&&(s=this.createChunk(i));let a=this.chunks[s],n=i-a.start,o=t.subarray(0,Math.min(c-n,t.byteLength));a.data.set(o,n);let g={start:n,end:n+o.byteLength};if(H(a,g),a.written[0].start===0&&a.written[0].end===c&&(a.shouldFlush=!0),this.chunks.length>N){for(let l=0;l<this.chunks.length-1;l++)this.chunks[l].shouldFlush=!0;this.flushChunks()}o.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(o.byteLength),i+o.byteLength)}createChunk(t){let s={start:Math.floor(t/c)*c,data:new Uint8Array(c),written:[],shouldFlush:!1};return this.chunks.push(s),this.chunks.sort((a,n)=>a.start-n.start),this.chunks.indexOf(s)}flushChunks(t=!1){for(let i=0;i<this.chunks.length;i++){let s=this.chunks[i];if(!(!s.shouldFlush&&!t)){for(let a of s.written)this.stream.write({type:"write",data:s.data.subarray(a.start,a.end),position:s.start+a.start});this.chunks.splice(i--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}},H=(r,e)=>{let t=0,i=r.written.length-1,s=-1;for(;t<=i;){let a=Math.floor(t+(i-t+1)/2);r.written[a].start<=e.start?(t=a+1,s=a):i=a-1}for(r.written.splice(s+1,0,e),(s===-1||r.written[s].end<e.start)&&s++;s<r.written.length-1&&r.written[s].end>=r.written[s+1].start;)r.written[s].end=Math.max(r.written[s].end,r.written[s+1].end),r.written.splice(s+1,1)};var m=1,k=2,_=1,O=2,C=h(2,15),x=h(2,12),T="https://github.com/Vanilagy/webm-muxer",U=6,V=5,y=class{constructor(e){this.duration=0;this.videoChunkQueue=[];this.audioChunkQueue=[];this.lastVideoTimestamp=0;this.lastAudioTimestamp=0;this.finalized=!1;this.options=e,e.target==="buffer"?this.target=new f:this.target=new p(e.target),this.createFileHeader()}createFileHeader(){this.writeEBMLHeader(),this.createSeekHead(),this.createSegmentInfo(),this.createTracks(),this.createSegment(),this.createCues()}writeEBMLHeader(){let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:"webm"},{id:17031,data:2},{id:17029,data:2}]};this.target.writeEBML(e)}createSeekHead(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),s={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]};this.seekHead=s}createSegmentInfo(){let e={id:17545,data:new u(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:T},{id:22337,data:T},e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};if(this.tracksElement=e,this.options.video){this.videoCodecPrivate={id:236,size:4,data:new Uint8Array(x)};let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};this.colourElement=t,e.data.push({id:174,data:[{id:215,data:m},{id:29637,data:m},{id:131,data:_},{id:134,data:this.options.video.codec},this.videoCodecPrivate,this.options.video.frameRate?{id:2352003,data:1e9/this.options.video.frameRate}:null,{id:224,data:[{id:176,data:this.options.video.width},{id:186,data:this.options.video.height},t]}].filter(Boolean)})}this.options.audio&&(this.audioCodecPrivate={id:236,size:4,data:new Uint8Array(x)},e.data.push({id:174,data:[{id:215,data:k},{id:29637,data:k},{id:131,data:O},{id:134,data:this.options.audio.codec},this.audioCodecPrivate,{id:225,data:[{id:181,data:new d(this.options.audio.sampleRate)},{id:159,data:this.options.audio.numberOfChannels},this.options.audio.bitDepth?{id:25188,data:this.options.audio.bitDepth}:null].filter(Boolean)}]}))}createSegment(){let e={id:408125543,size:U,data:[this.seekHead,this.segmentInfo,this.tracksElement]};this.segment=e,this.target.writeEBML(e)}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return this.target.dataOffsets.get(this.segment)}addVideoChunk(e,t,i){if(this.ensureNotFinalized(),!this.options.video)throw new Error("No video track declared.");let s=this.createInternalChunk(e,i);for(this.lastVideoTimestamp=s.timestamp;this.audioChunkQueue.length>0&&this.audioChunkQueue[0].timestamp<=s.timestamp;){let a=this.audioChunkQueue.shift();this.writeSimpleBlock(a)}if(!this.options.audio||s.timestamp<=this.lastAudioTimestamp?this.writeSimpleBlock(s):this.videoChunkQueue.push(s),t.decoderConfig){if(t.decoderConfig.colorSpace){let a=t.decoderConfig.colorSpace;this.colourElement.data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[a.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[a.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[a.primaries]},{id:21945,data:[1,2][Number(a.fullRange)]}];let n=this.target.pos;this.target.seek(this.target.offsets.get(this.colourElement)),this.target.writeEBML(this.colourElement),this.target.seek(n)}t.decoderConfig.description&&this.writeCodecPrivate(this.videoCodecPrivate,t.decoderConfig.description)}}addAudioChunk(e,t,i){if(this.ensureNotFinalized(),!this.options.audio)throw new Error("No audio track declared.");let s=this.createInternalChunk(e,i);for(this.lastAudioTimestamp=s.timestamp;this.videoChunkQueue.length>0&&this.videoChunkQueue[0].timestamp<=s.timestamp;){let a=this.videoChunkQueue.shift();this.writeSimpleBlock(a)}!this.options.video||s.timestamp<=this.lastVideoTimestamp?this.writeSimpleBlock(s):this.audioChunkQueue.push(s),t.decoderConfig&&this.writeCodecPrivate(this.audioCodecPrivate,t.decoderConfig.description)}createInternalChunk(e,t){let i=new Uint8Array(e.byteLength);return e.copyTo(i),{data:i,timestamp:t!=null?t:e.timestamp,type:e.type,trackNumber:e instanceof EncodedVideoChunk?m:k}}writeSimpleBlock(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-this.currentClusterTimestamp>=C)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${C} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${C} milliseconds.`);let s=(e.trackNumber===m||!this.options.video)&&e.type==="key"&&t-this.currentClusterTimestamp>=1e3;(!this.currentCluster||s)&&this.createNewCluster(t);let a=new Uint8Array(4),n=new DataView(a.buffer);n.setUint8(0,128|e.trackNumber),n.setUint16(1,t-this.currentClusterTimestamp,!1),n.setUint8(3,Number(e.type==="key")<<7);let o={id:163,data:[a,e.data]};this.target.writeEBML(o),this.duration=Math.max(this.duration,t)}writeCodecPrivate(e,t){let i=this.target.pos;this.target.seek(this.target.offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(x-2-4-t.byteLength)}],this.target.writeEBML(e),this.target.seek(i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.currentCluster={id:524531317,size:V,data:[{id:231,data:e}]},this.target.writeEBML(this.currentCluster),this.currentClusterTimestamp=e;let t=this.target.offsets.get(this.currentCluster)-this.segmentDataOffset;this.cues.data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:m},{id:241,data:t}]}]})}finalizeCurrentCluster(){let e=this.target.pos-this.target.dataOffsets.get(this.currentCluster),t=this.target.pos;this.target.seek(this.target.offsets.get(this.currentCluster)+4),this.target.writeEBMLVarInt(e,V),this.target.seek(t)}finalize(){for(;this.videoChunkQueue.length>0;)this.writeSimpleBlock(this.videoChunkQueue.shift());for(;this.audioChunkQueue.length>0;)this.writeSimpleBlock(this.audioChunkQueue.shift());this.finalizeCurrentCluster(),this.target.writeEBML(this.cues);let e=this.target.pos,t=this.target.pos-this.segmentDataOffset;return this.target.seek(this.target.offsets.get(this.segment)+4),this.target.writeEBMLVarInt(t,U),this.segmentDuration.data=new u(this.duration),this.target.seek(this.target.offsets.get(this.segmentDuration)),this.target.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.target.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.target.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.target.offsets.get(this.tracksElement)-this.segmentDataOffset,this.target.seek(this.target.offsets.get(this.seekHead)),this.target.writeEBML(this.seekHead),this.target.seek(e),this.finalized=!0,this.target instanceof f?this.target.finalize():(this.target instanceof p&&this.target.finalize(),null)}ensureNotFinalized(){if(this.finalized)throw new Error("Cannot add new video or audio chunks after the file has been finalized.")}},R=y;return F(Q);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
