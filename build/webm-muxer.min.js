"use strict";var WebMMuxer=(()=>{var he=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Ne=Object.prototype.hasOwnProperty;var b=Math.pow;var Re=(a,e)=>{for(var t in e)he(a,t,{get:e[t],enumerable:!0})},_e=(a,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ee(e))!Ne.call(a,r)&&r!==t&&he(a,r,{get:()=>e[r],enumerable:!(s=Pe(e,r))||s.enumerable});return a};var Oe=a=>_e(he({},"__esModule",{value:!0}),a);var oe=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var i=(a,e,t)=>(oe(a,e,"read from private field"),t?t.call(a):e.get(a)),o=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)},f=(a,e,t,s)=>(oe(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t);var d=(a,e,t)=>(oe(a,e,"access private method"),t);var qe={};Re(qe,{default:()=>Ze});var D=class{constructor(e){this.value=e}},x=class{constructor(e){this.value=e}};var L=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=pe(e)){let s=0;switch(t){case 6:this.helperView.setUint8(s++,e/b(2,40)|0);case 5:this.helperView.setUint8(s++,e/b(2,32)|0);case 4:this.helperView.setUint8(s++,e>>24);case 3:this.helperView.setUint8(s++,e>>16);case 2:this.helperView.setUint8(s++,e>>8);case 1:this.helperView.setUint8(s++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,s))}writeEBMLVarInt(e,t=Me(e)){let s=0;switch(t){case 1:this.helperView.setUint8(s++,1<<7|e);break;case 2:this.helperView.setUint8(s++,1<<6|e>>8),this.helperView.setUint8(s++,e);break;case 3:this.helperView.setUint8(s++,1<<5|e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 4:this.helperView.setUint8(s++,1<<4|e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 5:this.helperView.setUint8(s++,1<<3|e/b(2,32)&7),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 6:this.helperView.setUint8(s++,1<<2|e/b(2,40)&3),this.helperView.setUint8(s++,e/b(2,32)|0),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,s))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t,s;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let r of e)this.writeEBML(r);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let r=this.pos,h=(t=e.size)!=null?t:4;this.seek(this.pos+h);let l=this.pos;this.dataOffsets.set(e,l),this.writeEBML(e.data);let c=this.pos-l,W=this.pos;this.seek(r),this.writeEBMLVarInt(c,h),this.seek(W)}else if(typeof e.data=="number"){let r=(s=e.size)!=null?s:pe(e.data);this.writeEBMLVarInt(r),this.writeUnsignedInt(e.data,r)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof D?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof x&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},pe=a=>a<1<<8?1:a<1<<16?2:a<1<<24?3:a<b(2,32)?4:a<b(2,40)?5:6,Me=a=>{if(a<(1<<7)-1)return 1;if(a<(1<<14)-1)return 2;if(a<(1<<21)-1)return 3;if(a<(1<<28)-1)return 4;if(a<b(2,35)-1)return 5;if(a<b(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+a)},K=class extends L{constructor(){super();this.buffer=new ArrayBuffer(b(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let s=this.buffer.byteLength;for(;s<t;)s*=2;if(s===this.buffer.byteLength)return;let r=new ArrayBuffer(s),h=new Uint8Array(r);h.set(this.bytes,0),this.buffer=r,this.bytes=h}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},z=b(2,24),He=2,Y=class extends L{constructor(t){super();this.chunks=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,s){let r=this.chunks.findIndex(T=>T.start<=s&&s<T.start+z);r===-1&&(r=this.createChunk(s));let h=this.chunks[r],l=s-h.start,c=t.subarray(0,Math.min(z-l,t.byteLength));h.data.set(c,l);let W={start:l,end:l+c.byteLength};if(We(h,W),h.written[0].start===0&&h.written[0].end===z&&(h.shouldFlush=!0),this.chunks.length>He){for(let T=0;T<this.chunks.length-1;T++)this.chunks[T].shouldFlush=!0;this.flushChunks()}c.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(c.byteLength),s+c.byteLength)}createChunk(t){let r={start:Math.floor(t/z)*z,data:new Uint8Array(z),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((h,l)=>h.start-l.start),this.chunks.indexOf(r)}flushChunks(t=!1){for(let s=0;s<this.chunks.length;s++){let r=this.chunks[s];if(!(!r.shouldFlush&&!t)){for(let h of r.written)this.stream.write({type:"write",data:r.data.subarray(h.start,h.end),position:r.start+h.start});this.chunks.splice(s--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}},We=(a,e)=>{let t=0,s=a.written.length-1,r=-1;for(;t<=s;){let h=Math.floor(t+(s-t+1)/2);a.written[h].start<=e.start?(t=h+1,r=h):s=h-1}for(a.written.splice(r+1,0,e),(r===-1||a.written[r].end<e.start)&&r++;r<a.written.length-1&&a.written[r].end>=a.written[r+1].start;)a.written[r].end=Math.max(a.written[r].end,a.written[r+1].end),a.written.splice(r+1,1)};var Z=1,le=2,Ke=1,Ye=2,de=b(2,15),ue=b(2,12),ke="https://github.com/Vanilagy/webm-muxer",Ce=6,ye=5,n,u,E,N,m,R,U,V,_,O,S,w,A,M,p,k,X,q,H,G,v,xe,B,ge,I,Ue,ee,Ve,te,Se,ie,Ae,se,Te,y,P,re,De,ae,ze,Q,ce,C,g,$,be,ne,Fe,j,me,J,we,fe=class{constructor(e){o(this,v);o(this,B);o(this,I);o(this,ee);o(this,te);o(this,ie);o(this,se);o(this,y);o(this,re);o(this,ae);o(this,Q);o(this,C);o(this,$);o(this,ne);o(this,j);o(this,J);o(this,n,void 0);o(this,u,void 0);o(this,E,void 0);o(this,N,void 0);o(this,m,void 0);o(this,R,void 0);o(this,U,void 0);o(this,V,void 0);o(this,_,void 0);o(this,O,void 0);o(this,S,void 0);o(this,w,void 0);o(this,A,void 0);o(this,M,0);o(this,p,[]);o(this,k,[]);o(this,X,0);o(this,q,0);o(this,H,void 0);o(this,G,!1);f(this,u,e),e.target==="buffer"?f(this,n,new K):f(this,n,new Y(e.target)),d(this,v,xe).call(this)}addVideoChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addVideoChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addVideoChunkRaw(e,t,s,r){if(d(this,J,we).call(this),!i(this,u).video)throw new Error("No video track declared.");r&&d(this,re,De).call(this,r);let h=d(this,Q,ce).call(this,e,t,s,Z);for(i(this,u).video.codec==="V_VP9"&&d(this,ae,ze).call(this,h),f(this,X,h.timestamp);i(this,k).length>0&&i(this,k)[0].timestamp<=h.timestamp;){let l=i(this,k).shift();d(this,C,g).call(this,l)}!i(this,u).audio||h.timestamp<=i(this,q)?d(this,C,g).call(this,h):i(this,p).push(h)}addAudioChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addAudioChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addAudioChunkRaw(e,t,s,r){if(d(this,J,we).call(this),!i(this,u).audio)throw new Error("No audio track declared.");let h=d(this,Q,ce).call(this,e,t,s,le);for(f(this,q,h.timestamp);i(this,p).length>0&&i(this,p)[0].timestamp<=h.timestamp;){let l=i(this,p).shift();d(this,C,g).call(this,l)}!i(this,u).video||h.timestamp<=i(this,X)?d(this,C,g).call(this,h):i(this,k).push(h),r!=null&&r.decoderConfig&&d(this,$,be).call(this,i(this,O),r.decoderConfig.description)}finalize(){for(;i(this,p).length>0;)d(this,C,g).call(this,i(this,p).shift());for(;i(this,k).length>0;)d(this,C,g).call(this,i(this,k).shift());d(this,j,me).call(this),i(this,n).writeEBML(i(this,S));let e=i(this,n).pos,t=i(this,n).pos-i(this,y,P);return i(this,n).seek(i(this,n).offsets.get(i(this,E))+4),i(this,n).writeEBMLVarInt(t,Ce),i(this,U).data=new x(i(this,M)),i(this,n).seek(i(this,n).offsets.get(i(this,U))),i(this,n).writeEBML(i(this,U)),i(this,m).data[0].data[1].data=i(this,n).offsets.get(i(this,S))-i(this,y,P),i(this,m).data[1].data[1].data=i(this,n).offsets.get(i(this,N))-i(this,y,P),i(this,m).data[2].data[1].data=i(this,n).offsets.get(i(this,R))-i(this,y,P),i(this,n).seek(i(this,n).offsets.get(i(this,m))),i(this,n).writeEBML(i(this,m)),i(this,n).seek(e),f(this,G,!0),i(this,n)instanceof K?i(this,n).finalize():(i(this,n)instanceof Y&&i(this,n).finalize(),null)}};n=new WeakMap,u=new WeakMap,E=new WeakMap,N=new WeakMap,m=new WeakMap,R=new WeakMap,U=new WeakMap,V=new WeakMap,_=new WeakMap,O=new WeakMap,S=new WeakMap,w=new WeakMap,A=new WeakMap,M=new WeakMap,p=new WeakMap,k=new WeakMap,X=new WeakMap,q=new WeakMap,H=new WeakMap,G=new WeakMap,v=new WeakSet,xe=function(){d(this,B,ge).call(this),d(this,I,Ue).call(this),d(this,ee,Ve).call(this),d(this,te,Se).call(this),d(this,ie,Ae).call(this),d(this,se,Te).call(this)},B=new WeakSet,ge=function(){let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:"webm"},{id:17031,data:2},{id:17029,data:2}]};i(this,n).writeEBML(e)},I=new WeakSet,Ue=function(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]};f(this,m,r)},ee=new WeakSet,Ve=function(){let e={id:17545,data:new x(0)};f(this,U,e);let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:ke},{id:22337,data:ke},e]};f(this,N,t)},te=new WeakSet,Se=function(){let e={id:374648427,data:[]};if(f(this,R,e),i(this,u).video){f(this,_,{id:236,size:4,data:new Uint8Array(ue)});let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};f(this,V,t),e.data.push({id:174,data:[{id:215,data:Z},{id:29637,data:Z},{id:131,data:Ke},{id:134,data:i(this,u).video.codec},i(this,_),i(this,u).video.frameRate?{id:2352003,data:1e9/i(this,u).video.frameRate}:null,{id:224,data:[{id:176,data:i(this,u).video.width},{id:186,data:i(this,u).video.height},t]}].filter(Boolean)})}i(this,u).audio&&(f(this,O,{id:236,size:4,data:new Uint8Array(ue)}),e.data.push({id:174,data:[{id:215,data:le},{id:29637,data:le},{id:131,data:Ye},{id:134,data:i(this,u).audio.codec},i(this,O),{id:225,data:[{id:181,data:new D(i(this,u).audio.sampleRate)},{id:159,data:i(this,u).audio.numberOfChannels},i(this,u).audio.bitDepth?{id:25188,data:i(this,u).audio.bitDepth}:null].filter(Boolean)}]}))},ie=new WeakSet,Ae=function(){let e={id:408125543,size:Ce,data:[i(this,m),i(this,N),i(this,R)]};f(this,E,e),i(this,n).writeEBML(e)},se=new WeakSet,Te=function(){f(this,S,{id:475249515,data:[]})},y=new WeakSet,P=function(){return i(this,n).dataOffsets.get(i(this,E))},re=new WeakSet,De=function(e){if(e.decoderConfig){if(e.decoderConfig.colorSpace){let t=e.decoderConfig.colorSpace;f(this,H,t),i(this,V).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[t.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[t.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[t.primaries]},{id:21945,data:[1,2][Number(t.fullRange)]}];let s=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(i(this,V))),i(this,n).writeEBML(i(this,V)),i(this,n).seek(s)}e.decoderConfig.description&&d(this,$,be).call(this,i(this,_),e.decoderConfig.description)}},ae=new WeakSet,ze=function(e){if(e.type!=="key"||!i(this,H))return;let t=0;if(F(e.data,0,2)!==2)return;t+=2;let s=(F(e.data,t+1,t+2)<<1)+F(e.data,t+0,t+1);t+=2,s===3&&t++;let r=F(e.data,t+0,t+1);if(t++,r)return;let h=F(e.data,t+0,t+1);if(t++,h!==0)return;t+=2;let l=F(e.data,t+0,t+24);if(t+=24,l!==4817730)return;s>=2&&t++;let c={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[i(this,H).matrix];Xe(e.data,t+0,t+3,c)},Q=new WeakSet,ce=function(e,t,s,r){return{data:e,type:t,timestamp:s,trackNumber:r}},C=new WeakSet,g=function(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-i(this,A)>=de)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${de} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${de} milliseconds.`);let r=(e.trackNumber===Z||!i(this,u).video)&&e.type==="key"&&t-i(this,A)>=1e3;(!i(this,w)||r)&&d(this,ne,Fe).call(this,t);let h=new Uint8Array(4),l=new DataView(h.buffer);l.setUint8(0,128|e.trackNumber),l.setUint16(1,t-i(this,A),!1),l.setUint8(3,Number(e.type==="key")<<7);let c={id:163,data:[h,e.data]};i(this,n).writeEBML(c),f(this,M,Math.max(i(this,M),t))},$=new WeakSet,be=function(e,t){let s=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(ue-2-4-t.byteLength)}],i(this,n).writeEBML(e),i(this,n).seek(s)},ne=new WeakSet,Fe=function(e){i(this,w)&&d(this,j,me).call(this),f(this,w,{id:524531317,size:ye,data:[{id:231,data:e}]}),i(this,n).writeEBML(i(this,w)),f(this,A,e);let t=i(this,n).offsets.get(i(this,w))-i(this,y,P);i(this,S).data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:Z},{id:241,data:t}]}]})},j=new WeakSet,me=function(){let e=i(this,n).pos-i(this,n).dataOffsets.get(i(this,w)),t=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(i(this,w))+4),i(this,n).writeEBMLVarInt(e,ye),i(this,n).seek(t)},J=new WeakSet,we=function(){if(i(this,G))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var Ze=fe,F=(a,e,t)=>{let s=0;for(let r=e;r<t;r++){let h=Math.floor(r/8),l=a[h],c=7-(r&7),W=(l&1<<c)>>c;s<<=1,s|=W}return s},Xe=(a,e,t,s)=>{for(let r=e;r<t;r++){let h=Math.floor(r/8),l=a[h],c=7-(r&7);l&=~(1<<c),l|=(s&1<<t-r-1)>>t-r-1<<c,a[h]=l}};return Oe(qe);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
