"use strict";var WebMMuxer=(()=>{var C=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var h=Math.pow;var z=(s,e)=>{for(var t in e)C(s,t,{get:e[t],enumerable:!0})},F=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of v(e))!P.call(s,r)&&r!==t&&C(s,r,{get:()=>e[r],enumerable:!(i=D(e,r))||i.enumerable});return s};var E=s=>F(C({},"__esModule",{value:!0}),s);var W={};z(W,{default:()=>M});var d=class{constructor(e){this.value=e}},l=class{constructor(e){this.value=e}};var g=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=V(e)){let i=0;switch(t){case 6:this.helperView.setUint8(i++,e/h(2,40)|0);case 5:this.helperView.setUint8(i++,e/h(2,32)|0);case 4:this.helperView.setUint8(i++,e>>24);case 3:this.helperView.setUint8(i++,e>>16);case 2:this.helperView.setUint8(i++,e>>8);case 1:this.helperView.setUint8(i++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,i))}writeEBMLVarInt(e,t=N(e)){let i=0;switch(t){case 1:this.helperView.setUint8(i++,1<<7|e);break;case 2:this.helperView.setUint8(i++,1<<6|e>>8),this.helperView.setUint8(i++,e);break;case 3:this.helperView.setUint8(i++,1<<5|e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 4:this.helperView.setUint8(i++,1<<4|e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 5:this.helperView.setUint8(i++,1<<3|e/h(2,32)&7),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 6:this.helperView.setUint8(i++,1<<2|e/h(2,40)&3),this.helperView.setUint8(i++,e/h(2,32)|0),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,i))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t,i;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let r of e)this.writeEBML(r);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let r=this.pos,a=(t=e.size)!=null?t:4;this.seek(this.pos+a);let n=this.pos;this.dataOffsets.set(e,n),this.writeEBML(e.data);let o=this.pos-n,p=this.pos;this.seek(r),this.writeEBMLVarInt(o,a),this.seek(p)}else if(typeof e.data=="number"){let r=(i=e.size)!=null?i:V(e.data);this.writeEBMLVarInt(r),this.writeUnsignedInt(e.data,r)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof d?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof l&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},V=s=>s<1<<8?1:s<1<<16?2:s<1<<24?3:s<h(2,32)?4:s<h(2,40)?5:6,N=s=>{if(s<(1<<7)-1)return 1;if(s<(1<<14)-1)return 2;if(s<(1<<21)-1)return 3;if(s<(1<<28)-1)return 4;if(s<h(2,35)-1)return 5;if(s<h(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+s)},m=class extends g{constructor(){super();this.buffer=new ArrayBuffer(h(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let i=this.buffer.byteLength;for(;i<t;)i*=2;if(i===this.buffer.byteLength)return;let r=new ArrayBuffer(i),a=new Uint8Array(r);a.set(this.bytes,0),this.buffer=r,this.bytes=a}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},c=h(2,24),_=2,b=class extends g{constructor(t){super();this.chunks=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,i){let r=this.chunks.findIndex(u=>u.start<=i&&i<u.start+c);r===-1&&(r=this.createChunk(i));let a=this.chunks[r],n=i-a.start,o=t.subarray(0,Math.min(c-n,t.byteLength));a.data.set(o,n);let p={start:n,end:n+o.byteLength};if(H(a,p),a.written[0].start===0&&a.written[0].end===c&&(a.shouldFlush=!0),this.chunks.length>_){for(let u=0;u<this.chunks.length-1;u++)this.chunks[u].shouldFlush=!0;this.flushChunks()}o.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(o.byteLength),i+o.byteLength)}createChunk(t){let r={start:Math.floor(t/c)*c,data:new Uint8Array(c),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((a,n)=>a.start-n.start),this.chunks.indexOf(r)}flushChunks(t=!1){for(let i=0;i<this.chunks.length;i++){let r=this.chunks[i];if(!(!r.shouldFlush&&!t)){for(let a of r.written)this.stream.write({type:"write",data:r.data.subarray(a.start,a.end),position:r.start+a.start});this.chunks.splice(i--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}},H=(s,e)=>{let t=0,i=s.written.length-1,r=-1;for(;t<=i;){let a=Math.floor(t+(i-t+1)/2);s.written[a].start<=e.start?(t=a+1,r=a):i=a-1}for(s.written.splice(r+1,0,e),(r===-1||s.written[r].end<e.start)&&r++;r<s.written.length-1&&s.written[r].end>=s.written[r+1].start;)s.written[r].end=Math.max(s.written[r].end,s.written[r+1].end),s.written.splice(r+1,1)};var w=1,k=2,O=1,R=2,x=h(2,15),y=h(2,12),U="https://github.com/Vanilagy/webm-muxer",T=6,A=5,S=class{constructor(e){this.duration=0;this.videoChunkQueue=[];this.audioChunkQueue=[];this.lastVideoTimestamp=0;this.lastAudioTimestamp=0;this.finalized=!1;this.options=e,e.target==="buffer"?this.target=new m:this.target=new b(e.target),this.createFileHeader()}createFileHeader(){this.writeEBMLHeader(),this.createSeekHead(),this.createSegmentInfo(),this.createTracks(),this.createSegment(),this.createCues()}writeEBMLHeader(){let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:"webm"},{id:17031,data:2},{id:17029,data:2}]};this.target.writeEBML(e)}createSeekHead(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]};this.seekHead=r}createSegmentInfo(){let e={id:17545,data:new l(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:U},{id:22337,data:U},e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};if(this.tracksElement=e,this.options.video){this.videoCodecPrivate={id:236,size:4,data:new Uint8Array(y)};let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};this.colourElement=t,e.data.push({id:174,data:[{id:215,data:w},{id:29637,data:w},{id:131,data:O},{id:134,data:this.options.video.codec},this.videoCodecPrivate,this.options.video.frameRate?{id:2352003,data:1e9/this.options.video.frameRate}:null,{id:224,data:[{id:176,data:this.options.video.width},{id:186,data:this.options.video.height},t]}].filter(Boolean)})}this.options.audio&&(this.audioCodecPrivate={id:236,size:4,data:new Uint8Array(y)},e.data.push({id:174,data:[{id:215,data:k},{id:29637,data:k},{id:131,data:R},{id:134,data:this.options.audio.codec},this.audioCodecPrivate,{id:225,data:[{id:181,data:new d(this.options.audio.sampleRate)},{id:159,data:this.options.audio.numberOfChannels},this.options.audio.bitDepth?{id:25188,data:this.options.audio.bitDepth}:null].filter(Boolean)}]}))}createSegment(){let e={id:408125543,size:T,data:[this.seekHead,this.segmentInfo,this.tracksElement]};this.segment=e,this.target.writeEBML(e)}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return this.target.dataOffsets.get(this.segment)}addVideoChunk(e,t,i){if(this.ensureNotFinalized(),!this.options.video)throw new Error("No video track declared.");this.writeVideoDecoderConfig(t);let r=this.createInternalChunk(e,i);for(this.options.video.codec==="V_VP9"&&this.fixVP9ColorSpace(r),this.lastVideoTimestamp=r.timestamp;this.audioChunkQueue.length>0&&this.audioChunkQueue[0].timestamp<=r.timestamp;){let a=this.audioChunkQueue.shift();this.writeSimpleBlock(a)}!this.options.audio||r.timestamp<=this.lastAudioTimestamp?this.writeSimpleBlock(r):this.videoChunkQueue.push(r)}writeVideoDecoderConfig(e){if(e.decoderConfig){if(e.decoderConfig.colorSpace){let t=e.decoderConfig.colorSpace;this.colorSpace=t,this.colourElement.data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[t.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[t.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[t.primaries]},{id:21945,data:[1,2][Number(t.fullRange)]}];let i=this.target.pos;this.target.seek(this.target.offsets.get(this.colourElement)),this.target.writeEBML(this.colourElement),this.target.seek(i)}e.decoderConfig.description&&this.writeCodecPrivate(this.videoCodecPrivate,e.decoderConfig.description)}}fixVP9ColorSpace(e){if(e.type!=="key"||!this.colorSpace)return;let t=0;if(f(e.data,0,2)!==2)return;t+=2;let i=(f(e.data,t+1,t+2)<<1)+f(e.data,t+0,t+1);t+=2,i===3&&t++;let r=f(e.data,t+0,t+1);if(t++,r)return;let a=f(e.data,t+0,t+1);if(t++,a!==0)return;t+=2;let n=f(e.data,t+0,t+24);if(t+=24,n!==4817730)return;i>=2&&t++;let o={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[this.colorSpace.matrix];Q(e.data,t+0,t+3,o)}addAudioChunk(e,t,i){if(this.ensureNotFinalized(),!this.options.audio)throw new Error("No audio track declared.");let r=this.createInternalChunk(e,i);for(this.lastAudioTimestamp=r.timestamp;this.videoChunkQueue.length>0&&this.videoChunkQueue[0].timestamp<=r.timestamp;){let a=this.videoChunkQueue.shift();this.writeSimpleBlock(a)}!this.options.video||r.timestamp<=this.lastVideoTimestamp?this.writeSimpleBlock(r):this.audioChunkQueue.push(r),t.decoderConfig&&this.writeCodecPrivate(this.audioCodecPrivate,t.decoderConfig.description)}createInternalChunk(e,t){let i=new Uint8Array(e.byteLength);return e.copyTo(i),{data:i,timestamp:t!=null?t:e.timestamp,type:e.type,trackNumber:e instanceof EncodedVideoChunk?w:k}}writeSimpleBlock(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-this.currentClusterTimestamp>=x)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${x} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${x} milliseconds.`);let r=(e.trackNumber===w||!this.options.video)&&e.type==="key"&&t-this.currentClusterTimestamp>=1e3;(!this.currentCluster||r)&&this.createNewCluster(t);let a=new Uint8Array(4),n=new DataView(a.buffer);n.setUint8(0,128|e.trackNumber),n.setUint16(1,t-this.currentClusterTimestamp,!1),n.setUint8(3,Number(e.type==="key")<<7);let o={id:163,data:[a,e.data]};this.target.writeEBML(o),this.duration=Math.max(this.duration,t)}writeCodecPrivate(e,t){let i=this.target.pos;this.target.seek(this.target.offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(y-2-4-t.byteLength)}],this.target.writeEBML(e),this.target.seek(i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.currentCluster={id:524531317,size:A,data:[{id:231,data:e}]},this.target.writeEBML(this.currentCluster),this.currentClusterTimestamp=e;let t=this.target.offsets.get(this.currentCluster)-this.segmentDataOffset;this.cues.data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:w},{id:241,data:t}]}]})}finalizeCurrentCluster(){let e=this.target.pos-this.target.dataOffsets.get(this.currentCluster),t=this.target.pos;this.target.seek(this.target.offsets.get(this.currentCluster)+4),this.target.writeEBMLVarInt(e,A),this.target.seek(t)}finalize(){for(;this.videoChunkQueue.length>0;)this.writeSimpleBlock(this.videoChunkQueue.shift());for(;this.audioChunkQueue.length>0;)this.writeSimpleBlock(this.audioChunkQueue.shift());this.finalizeCurrentCluster(),this.target.writeEBML(this.cues);let e=this.target.pos,t=this.target.pos-this.segmentDataOffset;return this.target.seek(this.target.offsets.get(this.segment)+4),this.target.writeEBMLVarInt(t,T),this.segmentDuration.data=new l(this.duration),this.target.seek(this.target.offsets.get(this.segmentDuration)),this.target.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.target.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.target.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.target.offsets.get(this.tracksElement)-this.segmentDataOffset,this.target.seek(this.target.offsets.get(this.seekHead)),this.target.writeEBML(this.seekHead),this.target.seek(e),this.finalized=!0,this.target instanceof m?this.target.finalize():(this.target instanceof b&&this.target.finalize(),null)}ensureNotFinalized(){if(this.finalized)throw new Error("Cannot add new video or audio chunks after the file has been finalized.")}},M=S,f=(s,e,t)=>{let i=0;for(let r=e;r<t;r++){let a=Math.floor(r/8),n=s[a],o=7-(r&7),p=(n&1<<o)>>o;i<<=1,i|=p}return i},Q=(s,e,t,i)=>{for(let r=e;r<t;r++){let a=Math.floor(r/8),n=s[a],o=7-(r&7);n&=~(1<<o),n|=(i&1<<t-r-1)>>t-r-1<<o,s[a]=n}};return E(W);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
