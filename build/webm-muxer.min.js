"use strict";var WebMMuxer=(()=>{var oe=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var _e=Object.prototype.hasOwnProperty;var b=Math.pow;var Oe=(a,e)=>{for(var t in e)oe(a,t,{get:e[t],enumerable:!0})},Me=(a,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Re(e))!_e.call(a,r)&&r!==t&&oe(a,r,{get:()=>e[r],enumerable:!(s=Ne(e,r))||s.enumerable});return a};var We=a=>Me(oe({},"__esModule",{value:!0}),a);var le=(a,e,t)=>{if(!e.has(a))throw TypeError("Cannot "+t)};var i=(a,e,t)=>(le(a,e,"read from private field"),t?t.call(a):e.get(a)),o=(a,e,t)=>{if(e.has(a))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(a):e.set(a,t)},f=(a,e,t,s)=>(le(a,e,"write to private field"),s?s.call(a,t):e.set(a,t),t);var l=(a,e,t)=>(le(a,e,"access private method"),t);var Ge={};Oe(Ge,{default:()=>$e});var D=class{constructor(e){this.value=e}},x=class{constructor(e){this.value=e}};var v=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=ke(e)){let s=0;switch(t){case 6:this.helperView.setUint8(s++,e/b(2,40)|0);case 5:this.helperView.setUint8(s++,e/b(2,32)|0);case 4:this.helperView.setUint8(s++,e>>24);case 3:this.helperView.setUint8(s++,e>>16);case 2:this.helperView.setUint8(s++,e>>8);case 1:this.helperView.setUint8(s++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,s))}writeEBMLVarInt(e,t=He(e)){let s=0;switch(t){case 1:this.helperView.setUint8(s++,1<<7|e);break;case 2:this.helperView.setUint8(s++,1<<6|e>>8),this.helperView.setUint8(s++,e);break;case 3:this.helperView.setUint8(s++,1<<5|e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 4:this.helperView.setUint8(s++,1<<4|e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 5:this.helperView.setUint8(s++,1<<3|e/b(2,32)&7),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 6:this.helperView.setUint8(s++,1<<2|e/b(2,40)&3),this.helperView.setUint8(s++,e/b(2,32)|0),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,s))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t,s;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let r of e)this.writeEBML(r);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let r=this.pos,h=(t=e.size)!=null?t:4;this.seek(this.pos+h);let d=this.pos;this.dataOffsets.set(e,d),this.writeEBML(e.data);let c=this.pos-d,H=this.pos;this.seek(r),this.writeEBMLVarInt(c,h),this.seek(H)}else if(typeof e.data=="number"){let r=(s=e.size)!=null?s:ke(e.data);this.writeEBMLVarInt(r),this.writeUnsignedInt(e.data,r)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof D?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof x&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},ke=a=>a<1<<8?1:a<1<<16?2:a<1<<24?3:a<b(2,32)?4:a<b(2,40)?5:6,He=a=>{if(a<(1<<7)-1)return 1;if(a<(1<<14)-1)return 2;if(a<(1<<21)-1)return 3;if(a<(1<<28)-1)return 4;if(a<b(2,35)-1)return 5;if(a<b(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+a)},K=class extends v{constructor(){super();this.buffer=new ArrayBuffer(b(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let s=this.buffer.byteLength;for(;s<t;)s*=2;if(s===this.buffer.byteLength)return;let r=new ArrayBuffer(s),h=new Uint8Array(r);h.set(this.bytes,0),this.buffer=r,this.bytes=h}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},z=b(2,24),Ke=2,Y=class extends v{constructor(t){super();this.chunks=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,s){let r=this.chunks.findIndex(T=>T.start<=s&&s<T.start+z);r===-1&&(r=this.createChunk(s));let h=this.chunks[r],d=s-h.start,c=t.subarray(0,Math.min(z-d,t.byteLength));h.data.set(c,d);let H={start:d,end:d+c.byteLength};if(Ye(h,H),h.written[0].start===0&&h.written[0].end===z&&(h.shouldFlush=!0),this.chunks.length>Ke){for(let T=0;T<this.chunks.length-1;T++)this.chunks[T].shouldFlush=!0;this.flushChunks()}c.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(c.byteLength),s+c.byteLength)}createChunk(t){let r={start:Math.floor(t/z)*z,data:new Uint8Array(z),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((h,d)=>h.start-d.start),this.chunks.indexOf(r)}flushChunks(t=!1){for(let s=0;s<this.chunks.length;s++){let r=this.chunks[s];if(!(!r.shouldFlush&&!t)){for(let h of r.written)this.stream.write({type:"write",data:r.data.subarray(h.start,h.end),position:r.start+h.start});this.chunks.splice(s--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}},Ye=(a,e)=>{let t=0,s=a.written.length-1,r=-1;for(;t<=s;){let h=Math.floor(t+(s-t+1)/2);a.written[h].start<=e.start?(t=h+1,r=h):s=h-1}for(a.written.splice(r+1,0,e),(r===-1||a.written[r].end<e.start)&&r++;r<a.written.length-1&&a.written[r].end>=a.written[r+1].start;)a.written[r].end=Math.max(a.written[r].end,a.written[r+1].end),a.written.splice(r+1,1)};var Z=1,de=2,Ze=1,Xe=2,ue=b(2,15),fe=b(2,12),ye="https://github.com/Vanilagy/webm-muxer",Ce=6,xe=5,n,u,E,N,m,R,U,V,_,O,S,w,A,M,p,k,X,$,W,q,L,ge,B,Ue,I,Ve,ee,Se,te,Ae,ie,Te,se,De,re,ze,C,P,ae,Fe,ne,Pe,G,be,y,g,Q,me,he,Ee,j,we,J,pe,ce=class{constructor(e){o(this,L);o(this,B);o(this,I);o(this,ee);o(this,te);o(this,ie);o(this,se);o(this,re);o(this,C);o(this,ae);o(this,ne);o(this,G);o(this,y);o(this,Q);o(this,he);o(this,j);o(this,J);o(this,n,void 0);o(this,u,void 0);o(this,E,void 0);o(this,N,void 0);o(this,m,void 0);o(this,R,void 0);o(this,U,void 0);o(this,V,void 0);o(this,_,void 0);o(this,O,void 0);o(this,S,void 0);o(this,w,void 0);o(this,A,void 0);o(this,M,0);o(this,p,[]);o(this,k,[]);o(this,X,0);o(this,$,0);o(this,W,void 0);o(this,q,!1);l(this,L,ge).call(this,e),f(this,u,e),e.target==="buffer"?f(this,n,new K):f(this,n,new Y(e.target)),l(this,B,Ue).call(this)}addVideoChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addVideoChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addVideoChunkRaw(e,t,s,r){if(l(this,J,pe).call(this),!i(this,u).video)throw new Error("No video track declared.");r&&l(this,ae,Fe).call(this,r);let h=l(this,G,be).call(this,e,t,s,Z);for(i(this,u).video.codec==="V_VP9"&&l(this,ne,Pe).call(this,h),f(this,X,h.timestamp);i(this,k).length>0&&i(this,k)[0].timestamp<=h.timestamp;){let d=i(this,k).shift();l(this,y,g).call(this,d)}!i(this,u).audio||h.timestamp<=i(this,$)?l(this,y,g).call(this,h):i(this,p).push(h)}addAudioChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addAudioChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addAudioChunkRaw(e,t,s,r){if(l(this,J,pe).call(this),!i(this,u).audio)throw new Error("No audio track declared.");let h=l(this,G,be).call(this,e,t,s,de);for(f(this,$,h.timestamp);i(this,p).length>0&&i(this,p)[0].timestamp<=h.timestamp;){let d=i(this,p).shift();l(this,y,g).call(this,d)}!i(this,u).video||h.timestamp<=i(this,X)?l(this,y,g).call(this,h):i(this,k).push(h),r!=null&&r.decoderConfig&&l(this,Q,me).call(this,i(this,O),r.decoderConfig.description)}finalize(){for(;i(this,p).length>0;)l(this,y,g).call(this,i(this,p).shift());for(;i(this,k).length>0;)l(this,y,g).call(this,i(this,k).shift());l(this,j,we).call(this),i(this,n).writeEBML(i(this,S));let e=i(this,n).pos,t=i(this,n).pos-i(this,C,P);return i(this,n).seek(i(this,n).offsets.get(i(this,E))+4),i(this,n).writeEBMLVarInt(t,Ce),i(this,U).data=new x(i(this,M)),i(this,n).seek(i(this,n).offsets.get(i(this,U))),i(this,n).writeEBML(i(this,U)),i(this,m).data[0].data[1].data=i(this,n).offsets.get(i(this,S))-i(this,C,P),i(this,m).data[1].data[1].data=i(this,n).offsets.get(i(this,N))-i(this,C,P),i(this,m).data[2].data[1].data=i(this,n).offsets.get(i(this,R))-i(this,C,P),i(this,n).seek(i(this,n).offsets.get(i(this,m))),i(this,n).writeEBML(i(this,m)),i(this,n).seek(e),f(this,q,!0),i(this,n)instanceof K?i(this,n).finalize():(i(this,n)instanceof Y&&i(this,n).finalize(),null)}};n=new WeakMap,u=new WeakMap,E=new WeakMap,N=new WeakMap,m=new WeakMap,R=new WeakMap,U=new WeakMap,V=new WeakMap,_=new WeakMap,O=new WeakMap,S=new WeakMap,w=new WeakMap,A=new WeakMap,M=new WeakMap,p=new WeakMap,k=new WeakMap,X=new WeakMap,$=new WeakMap,W=new WeakMap,q=new WeakMap,L=new WeakSet,ge=function(e){if(e.type&&e.type!=="webm"&&e.type!=="matroska")throw new Error(`Invalid type: ${e.type}`)},B=new WeakSet,Ue=function(){l(this,I,Ve).call(this),l(this,ee,Se).call(this),l(this,te,Ae).call(this),l(this,ie,Te).call(this),l(this,se,De).call(this),l(this,re,ze).call(this)},I=new WeakSet,Ve=function(){var t;let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:(t=i(this,u).type)!=null?t:"webm"},{id:17031,data:2},{id:17029,data:2}]};i(this,n).writeEBML(e)},ee=new WeakSet,Se=function(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]};f(this,m,r)},te=new WeakSet,Ae=function(){let e={id:17545,data:new x(0)};f(this,U,e);let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:ye},{id:22337,data:ye},e]};f(this,N,t)},ie=new WeakSet,Te=function(){let e={id:374648427,data:[]};if(f(this,R,e),i(this,u).video){f(this,_,{id:236,size:4,data:new Uint8Array(fe)});let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};f(this,V,t),e.data.push({id:174,data:[{id:215,data:Z},{id:29637,data:Z},{id:131,data:Ze},{id:134,data:i(this,u).video.codec},i(this,_),i(this,u).video.frameRate?{id:2352003,data:1e9/i(this,u).video.frameRate}:null,{id:224,data:[{id:176,data:i(this,u).video.width},{id:186,data:i(this,u).video.height},t]}].filter(Boolean)})}i(this,u).audio&&(f(this,O,{id:236,size:4,data:new Uint8Array(fe)}),e.data.push({id:174,data:[{id:215,data:de},{id:29637,data:de},{id:131,data:Xe},{id:134,data:i(this,u).audio.codec},i(this,O),{id:225,data:[{id:181,data:new D(i(this,u).audio.sampleRate)},{id:159,data:i(this,u).audio.numberOfChannels},i(this,u).audio.bitDepth?{id:25188,data:i(this,u).audio.bitDepth}:null].filter(Boolean)}]}))},se=new WeakSet,De=function(){let e={id:408125543,size:Ce,data:[i(this,m),i(this,N),i(this,R)]};f(this,E,e),i(this,n).writeEBML(e)},re=new WeakSet,ze=function(){f(this,S,{id:475249515,data:[]})},C=new WeakSet,P=function(){return i(this,n).dataOffsets.get(i(this,E))},ae=new WeakSet,Fe=function(e){if(e.decoderConfig){if(e.decoderConfig.colorSpace){let t=e.decoderConfig.colorSpace;f(this,W,t),i(this,V).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[t.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[t.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[t.primaries]},{id:21945,data:[1,2][Number(t.fullRange)]}];let s=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(i(this,V))),i(this,n).writeEBML(i(this,V)),i(this,n).seek(s)}e.decoderConfig.description&&l(this,Q,me).call(this,i(this,_),e.decoderConfig.description)}},ne=new WeakSet,Pe=function(e){if(e.type!=="key"||!i(this,W))return;let t=0;if(F(e.data,0,2)!==2)return;t+=2;let s=(F(e.data,t+1,t+2)<<1)+F(e.data,t+0,t+1);t+=2,s===3&&t++;let r=F(e.data,t+0,t+1);if(t++,r)return;let h=F(e.data,t+0,t+1);if(t++,h!==0)return;t+=2;let d=F(e.data,t+0,t+24);if(t+=24,d!==4817730)return;s>=2&&t++;let c={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[i(this,W).matrix];qe(e.data,t+0,t+3,c)},G=new WeakSet,be=function(e,t,s,r){return{data:e,type:t,timestamp:s,trackNumber:r}},y=new WeakSet,g=function(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-i(this,A)>=ue)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${ue} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${ue} milliseconds.`);let r=(e.trackNumber===Z||!i(this,u).video)&&e.type==="key"&&t-i(this,A)>=1e3;(!i(this,w)||r)&&l(this,he,Ee).call(this,t);let h=new Uint8Array(4),d=new DataView(h.buffer);d.setUint8(0,128|e.trackNumber),d.setUint16(1,t-i(this,A),!1),d.setUint8(3,Number(e.type==="key")<<7);let c={id:163,data:[h,e.data]};i(this,n).writeEBML(c),f(this,M,Math.max(i(this,M),t))},Q=new WeakSet,me=function(e,t){let s=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(fe-2-4-t.byteLength)}],i(this,n).writeEBML(e),i(this,n).seek(s)},he=new WeakSet,Ee=function(e){i(this,w)&&l(this,j,we).call(this),f(this,w,{id:524531317,size:xe,data:[{id:231,data:e}]}),i(this,n).writeEBML(i(this,w)),f(this,A,e);let t=i(this,n).offsets.get(i(this,w))-i(this,C,P);i(this,S).data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:Z},{id:241,data:t}]}]})},j=new WeakSet,we=function(){let e=i(this,n).pos-i(this,n).dataOffsets.get(i(this,w)),t=i(this,n).pos;i(this,n).seek(i(this,n).offsets.get(i(this,w))+4),i(this,n).writeEBMLVarInt(e,xe),i(this,n).seek(t)},J=new WeakSet,pe=function(){if(i(this,q))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var $e=ce,F=(a,e,t)=>{let s=0;for(let r=e;r<t;r++){let h=Math.floor(r/8),d=a[h],c=7-(r&7),H=(d&1<<c)>>c;s<<=1,s|=H}return s},qe=(a,e,t,s)=>{for(let r=e;r<t;r++){let h=Math.floor(r/8),d=a[h],c=7-(r&7);d&=~(1<<c),d|=(s&1<<t-r-1)>>t-r-1<<c,a[h]=d}};return We(Ge);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
