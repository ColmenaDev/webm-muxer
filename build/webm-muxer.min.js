"use strict";var WebMMuxer=(()=>{var ce=Object.defineProperty;var We=Object.getOwnPropertyDescriptor;var He=Object.getOwnPropertyNames;var Ke=Object.prototype.hasOwnProperty;var b=Math.pow;var Ye=(n,e)=>{for(var t in e)ce(n,t,{get:e[t],enumerable:!0})},Ze=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of He(e))!Ke.call(n,r)&&r!==t&&ce(n,r,{get:()=>e[r],enumerable:!(s=We(e,r))||s.enumerable});return n};var $e=n=>Ze(ce({},"__esModule",{value:!0}),n);var be=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var i=(n,e,t)=>(be(n,e,"read from private field"),t?t.call(n):e.get(n)),o=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},f=(n,e,t,s)=>(be(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t);var d=(n,e,t)=>(be(n,e,"access private method"),t);var Je={};Ye(Je,{default:()=>Qe});var D=class{constructor(e){this.value=e}},x=class{constructor(e){this.value=e}};var $=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap;this.dataOffsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=Ue(e)){let s=0;switch(t){case 6:this.helperView.setUint8(s++,e/b(2,40)|0);case 5:this.helperView.setUint8(s++,e/b(2,32)|0);case 4:this.helperView.setUint8(s++,e>>24);case 3:this.helperView.setUint8(s++,e>>16);case 2:this.helperView.setUint8(s++,e>>8);case 1:this.helperView.setUint8(s++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,s))}writeEBMLVarInt(e,t=Xe(e)){let s=0;switch(t){case 1:this.helperView.setUint8(s++,1<<7|e);break;case 2:this.helperView.setUint8(s++,1<<6|e>>8),this.helperView.setUint8(s++,e);break;case 3:this.helperView.setUint8(s++,1<<5|e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 4:this.helperView.setUint8(s++,1<<4|e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 5:this.helperView.setUint8(s++,1<<3|e/b(2,32)&7),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;case 6:this.helperView.setUint8(s++,1<<2|e/b(2,40)&3),this.helperView.setUint8(s++,e/b(2,32)|0),this.helperView.setUint8(s++,e>>24),this.helperView.setUint8(s++,e>>16),this.helperView.setUint8(s++,e>>8),this.helperView.setUint8(s++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,s))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t,s;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let r of e)this.writeEBML(r);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let r=this.pos,a=(t=e.size)!=null?t:4;this.seek(this.pos+a);let l=this.pos;this.dataOffsets.set(e,l),this.writeEBML(e.data);let u=this.pos-l,Z=this.pos;this.seek(r),this.writeEBMLVarInt(u,a),this.seek(Z)}else if(typeof e.data=="number"){let r=(s=e.size)!=null?s:Ue(e.data);this.writeEBMLVarInt(r),this.writeUnsignedInt(e.data,r)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof D?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof x&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},Ue=n=>n<1<<8?1:n<1<<16?2:n<1<<24?3:n<b(2,32)?4:n<b(2,40)?5:6,Xe=n=>{if(n<(1<<7)-1)return 1;if(n<(1<<14)-1)return 2;if(n<(1<<21)-1)return 3;if(n<(1<<28)-1)return 4;if(n<b(2,35)-1)return 5;if(n<b(2,42)-1)return 6;throw new Error("EBML VINT size not supported "+n)},X=class extends ${constructor(){super();this.buffer=new ArrayBuffer(b(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let s=this.buffer.byteLength;for(;s<t;)s*=2;if(s===this.buffer.byteLength)return;let r=new ArrayBuffer(s),a=new Uint8Array(r);a.set(this.bytes,0),this.buffer=r,this.bytes=a}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},F=b(2,24),qe=2,q=class extends ${constructor(t){super();this.chunks=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,s){let r=this.chunks.findIndex(z=>z.start<=s&&s<z.start+F);r===-1&&(r=this.createChunk(s));let a=this.chunks[r],l=s-a.start,u=t.subarray(0,Math.min(F-l,t.byteLength));a.data.set(u,l);let Z={start:l,end:l+u.byteLength};if(ve(a,Z),a.written[0].start===0&&a.written[0].end===F&&(a.shouldFlush=!0),this.chunks.length>qe){for(let z=0;z<this.chunks.length-1;z++)this.chunks[z].shouldFlush=!0;this.flushChunks()}u.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(u.byteLength),s+u.byteLength)}createChunk(t){let r={start:Math.floor(t/F)*F,data:new Uint8Array(F),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((a,l)=>a.start-l.start),this.chunks.indexOf(r)}flushChunks(t=!1){for(let s=0;s<this.chunks.length;s++){let r=this.chunks[s];if(!(!r.shouldFlush&&!t)){for(let a of r.written)this.stream.write({type:"write",data:r.data.subarray(a.start,a.end),position:r.start+a.start});this.chunks.splice(s--,1)}}}seek(t){this.pos=t}finalize(){this.flushChunks(!0)}},ve=(n,e)=>{let t=0,s=n.written.length-1,r=-1;for(;t<=s;){let a=Math.floor(t+(s-t+1)/2);n.written[a].start<=e.start?(t=a+1,r=a):s=a-1}for(n.written.splice(r+1,0,e),(r===-1||n.written[r].end<e.start)&&r++;r<n.written.length-1&&n.written[r].end>=n.written[r+1].start;)n.written[r].end=Math.max(n.written[r].end,n.written[r+1].end),n.written.splice(r+1,1)},g,v,P=class extends ${constructor(t){super();o(this,g,[]);o(this,v,void 0);f(this,v,t)}write(t){i(this,g).push({data:t.slice(),start:this.pos}),this.pos+=t.byteLength}seek(t){this.pos=t}flush(t){if(i(this,g).length===0)return;let s=[],r=[...i(this,g)].sort((a,l)=>a.start-l.start);s.push({start:r[0].start,size:r[0].data.byteLength});for(let a=1;a<r.length;a++){let l=s[s.length-1],u=r[a];u.start<=l.start+l.size?l.size=Math.max(l.size,u.start+u.data.byteLength-l.start):s.push({start:u.start,size:u.data.byteLength})}for(let a of s){a.data=new Uint8Array(a.size);for(let u of i(this,g))a.start<=u.start&&u.start<a.start+a.size&&a.data.set(u.data,u.start-a.start);let l=t&&a===s[s.length-1];i(this,v).call(this,a.data,a.start,l)}i(this,g).length=0}};g=new WeakMap,v=new WeakMap;var G=1,me=2,Ge=1,Le=2,we=b(2,15),pe=b(2,12),Ve="https://github.com/Vanilagy/webm-muxer",Ae=6,Se=5,h,c,R,_,m,O,V,A,M,W,S,w,T,H,p,y,L,Q,K,j,ie,Te,se,ze,re,De,ae,Fe,ne,Pe,he,Ee,oe,Ne,le,Re,Y,te,C,N,de,_e,ue,Oe,J,ke,k,U,B,ge,fe,Me,I,Ce,ee,xe,ye=class{constructor(e){o(this,ie);o(this,se);o(this,re);o(this,ae);o(this,ne);o(this,he);o(this,oe);o(this,le);o(this,Y);o(this,C);o(this,de);o(this,ue);o(this,J);o(this,k);o(this,B);o(this,fe);o(this,I);o(this,ee);o(this,h,void 0);o(this,c,void 0);o(this,R,void 0);o(this,_,void 0);o(this,m,void 0);o(this,O,void 0);o(this,V,void 0);o(this,A,void 0);o(this,M,void 0);o(this,W,void 0);o(this,S,void 0);o(this,w,void 0);o(this,T,void 0);o(this,H,0);o(this,p,[]);o(this,y,[]);o(this,L,0);o(this,Q,0);o(this,K,void 0);o(this,j,!1);if(d(this,ie,Te).call(this,e),f(this,c,e),e.target==="buffer")f(this,h,new X);else if(e.target instanceof FileSystemWritableFileStream)f(this,h,new q(e.target));else if(typeof e.target=="function")f(this,h,new P(e.target));else throw new Error(`Invalid target: ${e.target}`);d(this,se,ze).call(this)}addVideoChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addVideoChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addVideoChunkRaw(e,t,s,r){if(d(this,ee,xe).call(this),!i(this,c).video)throw new Error("No video track declared.");r&&d(this,de,_e).call(this,r);let a=d(this,J,ke).call(this,e,t,s,G);for(i(this,c).video.codec==="V_VP9"&&d(this,ue,Oe).call(this,a),f(this,L,a.timestamp);i(this,y).length>0&&i(this,y)[0].timestamp<=a.timestamp;){let l=i(this,y).shift();d(this,k,U).call(this,l)}!i(this,c).audio||a.timestamp<=i(this,Q)?d(this,k,U).call(this,a):i(this,p).push(a),d(this,Y,te).call(this)}addAudioChunk(e,t,s){let r=new Uint8Array(e.byteLength);e.copyTo(r),this.addAudioChunkRaw(r,e.type,s!=null?s:e.timestamp,t)}addAudioChunkRaw(e,t,s,r){if(d(this,ee,xe).call(this),!i(this,c).audio)throw new Error("No audio track declared.");let a=d(this,J,ke).call(this,e,t,s,me);for(f(this,Q,a.timestamp);i(this,p).length>0&&i(this,p)[0].timestamp<=a.timestamp;){let l=i(this,p).shift();d(this,k,U).call(this,l)}!i(this,c).video||a.timestamp<=i(this,L)?d(this,k,U).call(this,a):i(this,y).push(a),r!=null&&r.decoderConfig&&d(this,B,ge).call(this,i(this,W),r.decoderConfig.description),d(this,Y,te).call(this)}finalize(){for(;i(this,p).length>0;)d(this,k,U).call(this,i(this,p).shift());for(;i(this,y).length>0;)d(this,k,U).call(this,i(this,y).shift());d(this,I,Ce).call(this),i(this,h).writeEBML(i(this,S));let e=i(this,h).pos,t=i(this,h).pos-i(this,C,N);return i(this,h).seek(i(this,h).offsets.get(i(this,R))+4),i(this,h).writeEBMLVarInt(t,Ae),i(this,V).data=new x(i(this,H)),i(this,h).seek(i(this,h).offsets.get(i(this,V))),i(this,h).writeEBML(i(this,V)),i(this,m).data[0].data[1].data=i(this,h).offsets.get(i(this,S))-i(this,C,N),i(this,m).data[1].data[1].data=i(this,h).offsets.get(i(this,_))-i(this,C,N),i(this,m).data[2].data[1].data=i(this,h).offsets.get(i(this,O))-i(this,C,N),i(this,h).seek(i(this,h).offsets.get(i(this,m))),i(this,h).writeEBML(i(this,m)),i(this,h).seek(e),f(this,j,!0),i(this,h)instanceof X?i(this,h).finalize():(i(this,h)instanceof q?i(this,h).finalize():i(this,h)instanceof P&&i(this,h).flush(!0),null)}};h=new WeakMap,c=new WeakMap,R=new WeakMap,_=new WeakMap,m=new WeakMap,O=new WeakMap,V=new WeakMap,A=new WeakMap,M=new WeakMap,W=new WeakMap,S=new WeakMap,w=new WeakMap,T=new WeakMap,H=new WeakMap,p=new WeakMap,y=new WeakMap,L=new WeakMap,Q=new WeakMap,K=new WeakMap,j=new WeakMap,ie=new WeakSet,Te=function(e){if(e.type&&e.type!=="webm"&&e.type!=="matroska")throw new Error(`Invalid type: ${e.type}`)},se=new WeakSet,ze=function(){d(this,re,De).call(this),d(this,ae,Fe).call(this),d(this,ne,Pe).call(this),d(this,he,Ee).call(this),d(this,oe,Ne).call(this),d(this,le,Re).call(this),d(this,Y,te).call(this)},re=new WeakSet,De=function(){var t;let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:(t=i(this,c).type)!=null?t:"webm"},{id:17031,data:2},{id:17029,data:2}]};i(this,h).writeEBML(e)},ae=new WeakSet,Fe=function(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),s=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:0}]}]};f(this,m,r)},ne=new WeakSet,Pe=function(){let e={id:17545,data:new x(0)};f(this,V,e);let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:Ve},{id:22337,data:Ve},e]};f(this,_,t)},he=new WeakSet,Ee=function(){let e={id:374648427,data:[]};if(f(this,O,e),i(this,c).video){f(this,M,{id:236,size:4,data:new Uint8Array(pe)});let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};f(this,A,t),e.data.push({id:174,data:[{id:215,data:G},{id:29637,data:G},{id:131,data:Ge},{id:134,data:i(this,c).video.codec},i(this,M),i(this,c).video.frameRate?{id:2352003,data:1e9/i(this,c).video.frameRate}:null,{id:224,data:[{id:176,data:i(this,c).video.width},{id:186,data:i(this,c).video.height},t]}].filter(Boolean)})}i(this,c).audio&&(f(this,W,{id:236,size:4,data:new Uint8Array(pe)}),e.data.push({id:174,data:[{id:215,data:me},{id:29637,data:me},{id:131,data:Le},{id:134,data:i(this,c).audio.codec},i(this,W),{id:225,data:[{id:181,data:new D(i(this,c).audio.sampleRate)},{id:159,data:i(this,c).audio.numberOfChannels},i(this,c).audio.bitDepth?{id:25188,data:i(this,c).audio.bitDepth}:null].filter(Boolean)}]}))},oe=new WeakSet,Ne=function(){let e={id:408125543,size:Ae,data:[i(this,m),i(this,_),i(this,O)]};f(this,R,e),i(this,h).writeEBML(e)},le=new WeakSet,Re=function(){f(this,S,{id:475249515,data:[]})},Y=new WeakSet,te=function(){i(this,h)instanceof P&&i(this,h).flush(!1)},C=new WeakSet,N=function(){return i(this,h).dataOffsets.get(i(this,R))},de=new WeakSet,_e=function(e){if(e.decoderConfig){if(e.decoderConfig.colorSpace){let t=e.decoderConfig.colorSpace;f(this,K,t),i(this,A).data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[t.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[t.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[t.primaries]},{id:21945,data:[1,2][Number(t.fullRange)]}];let s=i(this,h).pos;i(this,h).seek(i(this,h).offsets.get(i(this,A))),i(this,h).writeEBML(i(this,A)),i(this,h).seek(s)}e.decoderConfig.description&&d(this,B,ge).call(this,i(this,M),e.decoderConfig.description)}},ue=new WeakSet,Oe=function(e){if(e.type!=="key"||!i(this,K))return;let t=0;if(E(e.data,0,2)!==2)return;t+=2;let s=(E(e.data,t+1,t+2)<<1)+E(e.data,t+0,t+1);t+=2,s===3&&t++;let r=E(e.data,t+0,t+1);if(t++,r)return;let a=E(e.data,t+0,t+1);if(t++,a!==0)return;t+=2;let l=E(e.data,t+0,t+24);if(t+=24,l!==4817730)return;s>=2&&t++;let u={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[i(this,K).matrix];je(e.data,t+0,t+3,u)},J=new WeakSet,ke=function(e,t,s,r){return{data:e,type:t,timestamp:s,trackNumber:r}},k=new WeakSet,U=function(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-i(this,T)>=we)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${we} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${we} milliseconds.`);let r=(e.trackNumber===G||!i(this,c).video)&&e.type==="key"&&t-i(this,T)>=1e3;(!i(this,w)||r)&&d(this,fe,Me).call(this,t);let a=new Uint8Array(4),l=new DataView(a.buffer);l.setUint8(0,128|e.trackNumber),l.setUint16(1,t-i(this,T),!1),l.setUint8(3,Number(e.type==="key")<<7);let u={id:163,data:[a,e.data]};i(this,h).writeEBML(u),f(this,H,Math.max(i(this,H),t))},B=new WeakSet,ge=function(e,t){let s=i(this,h).pos;i(this,h).seek(i(this,h).offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(pe-2-4-t.byteLength)}],i(this,h).writeEBML(e),i(this,h).seek(s)},fe=new WeakSet,Me=function(e){i(this,w)&&d(this,I,Ce).call(this),f(this,w,{id:524531317,size:Se,data:[{id:231,data:e}]}),i(this,h).writeEBML(i(this,w)),f(this,T,e);let t=i(this,h).offsets.get(i(this,w))-i(this,C,N);i(this,S).data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:G},{id:241,data:t}]}]})},I=new WeakSet,Ce=function(){let e=i(this,h).pos-i(this,h).dataOffsets.get(i(this,w)),t=i(this,h).pos;i(this,h).seek(i(this,h).offsets.get(i(this,w))+4),i(this,h).writeEBMLVarInt(e,Se),i(this,h).seek(t)},ee=new WeakSet,xe=function(){if(i(this,j))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var Qe=ye,E=(n,e,t)=>{let s=0;for(let r=e;r<t;r++){let a=Math.floor(r/8),l=n[a],u=7-(r&7),Z=(l&1<<u)>>u;s<<=1,s|=Z}return s},je=(n,e,t,s)=>{for(let r=e;r<t;r++){let a=Math.floor(r/8),l=n[a],u=7-(r&7);l&=~(1<<u),l|=(s&1<<t-r-1)>>t-r-1<<u,n[a]=l}};return $e(Je);})();
WebMMuxer = WebMMuxer.default;
if (typeof module === "object" && typeof module.exports === "object") module.exports = WebMMuxer;
