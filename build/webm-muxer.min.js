"use strict";var WebMMuxer=(()=>{var w=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var o=Math.pow;var A=(s,e)=>{for(var t in e)w(s,t,{get:e[t],enumerable:!0})},v=(s,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of S(e))!U.call(s,r)&&r!==t&&w(s,r,{get:()=>e[r],enumerable:!(i=V(e,r))||i.enumerable});return s};var D=s=>v(w({},"__esModule",{value:!0}),s);var R={};A(R,{default:()=>H});var l=class{constructor(e){this.value=e}},u=class{constructor(e){this.value=e}};var p=class{constructor(){this.pos=0;this.helper=new Uint8Array(8);this.helperView=new DataView(this.helper.buffer);this.offsets=new WeakMap}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.write(this.helper)}writeUnsignedInt(e,t=T(e)){let i=0;switch(t){case 5:this.helperView.setUint8(i++,Math.floor(e/o(2,32)));case 4:this.helperView.setUint8(i++,e>>24);case 3:this.helperView.setUint8(i++,e>>16);case 2:this.helperView.setUint8(i++,e>>8);case 1:this.helperView.setUint8(i++,e);break;default:throw new Error("Bad UINT size "+t)}this.write(this.helper.subarray(0,i))}writeEBMLVarInt(e,t=F(e)){let i=0;switch(t){case 1:this.helperView.setUint8(i++,1<<7|e);break;case 2:this.helperView.setUint8(i++,1<<6|e>>8),this.helperView.setUint8(i++,e);break;case 3:this.helperView.setUint8(i++,1<<5|e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 4:this.helperView.setUint8(i++,1<<4|e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;case 5:this.helperView.setUint8(i++,1<<3|e/4294967296&7),this.helperView.setUint8(i++,e>>24),this.helperView.setUint8(i++,e>>16),this.helperView.setUint8(i++,e>>8),this.helperView.setUint8(i++,e);break;default:throw new Error("Bad EBML VINT size "+t)}this.write(this.helper.subarray(0,i))}writeString(e){this.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){var t;if(e instanceof Uint8Array)this.write(e);else if(Array.isArray(e))for(let i of e)this.writeEBML(i);else if(this.offsets.set(e,this.pos),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let i=this.pos;this.seek(this.pos+4);let r=this.pos;this.writeEBML(e.data);let a=this.pos-r,n=this.pos;this.seek(i),this.writeEBMLVarInt(a,4),this.seek(n)}else if(typeof e.data=="number"){let i=(t=e.size)!=null?t:T(e.data);this.writeEBMLVarInt(i),this.writeUnsignedInt(e.data,i)}else typeof e.data=="string"?(this.writeEBMLVarInt(e.data.length),this.writeString(e.data)):e.data instanceof Uint8Array?(this.writeEBMLVarInt(e.data.byteLength,e.size),this.write(e.data)):e.data instanceof l?(this.writeEBMLVarInt(4),this.writeFloat32(e.data.value)):e.data instanceof u&&(this.writeEBMLVarInt(8),this.writeFloat64(e.data.value))}},T=s=>s<1<<8?1:s<1<<16?2:s<1<<24?3:s<o(2,32)?4:5,F=s=>{if(s<(1<<7)-1)return 1;if(s<(1<<14)-1)return 2;if(s<(1<<21)-1)return 3;if(s<(1<<28)-1)return 4;if(s<o(2,35)-1)return 5;throw new Error("EBML VINT size not supported "+s)},c=class extends p{constructor(){super();this.buffer=new ArrayBuffer(o(2,16));this.bytes=new Uint8Array(this.buffer)}ensureSize(t){let i=this.buffer.byteLength;for(;i<t;)i*=2;if(i===this.buffer.byteLength)return;let r=new ArrayBuffer(i),a=new Uint8Array(r);a.set(this.bytes,0),this.buffer=r,this.bytes=a}write(t){this.ensureSize(this.pos+t.byteLength),this.bytes.set(t,this.pos),this.pos+=t.byteLength}seek(t){this.pos=t}finalize(){return this.ensureSize(this.pos),this.buffer.slice(0,this.pos)}},d=o(2,24),f=class extends p{constructor(t){super();this.chunks=[];this.toFlush=[];this.stream=t}write(t){this.writeDataIntoChunks(t,this.pos),this.flushChunks(),this.pos+=t.byteLength}writeDataIntoChunks(t,i){let r=this.chunks.findIndex(y=>y.start<=i&&i<y.start+d);r===-1&&(r=this.createChunk(i));let a=this.chunks[r],n=i-a.start,h=t.subarray(0,Math.min(d-n,t.byteLength));a.data.set(h,n);let g={start:n,end:n+h.byteLength};P(a,g),a.written[0].start===0&&a.written[0].end===d&&(this.toFlush.push(a),this.chunks.splice(r,1)),h.byteLength<t.byteLength&&this.writeDataIntoChunks(t.subarray(h.byteLength),i+h.byteLength)}createChunk(t){let r={start:Math.floor(t/d)*d,data:new Uint8Array(d),written:[]};return this.chunks.push(r),this.chunks.length-1}flushChunks(){if(this.toFlush.length>0){for(let t of this.toFlush)for(let i of t.written)this.stream.write({type:"write",data:t.data.subarray(i.start,i.end),position:t.start+i.start});this.toFlush.length=0}}seek(t){this.pos=t}finalize(){this.toFlush.push(...this.chunks),this.chunks.length=0,this.flushChunks()}},P=(s,e)=>{let t=0,i=s.written.length-1,r=-1;for(;t<=i;){let a=Math.floor(t+(i-t+1)/2);s.written[a].start<=e.start?(t=a+1,r=a):i=a-1}for(s.written.splice(r+1,0,e),(r===-1||s.written[r].end<e.start)&&r++;r<s.written.length-1&&s.written[r].end>=s.written[r+1].start;)s.written[r].end=Math.max(s.written[r].end,s.written[r+1].end),s.written.splice(r+1,1)};var m=1,b=2,z=1,E=2,C=o(2,15),k=o(2,12),x=class{constructor(e){this.duration=0;this.videoChunkQueue=[];this.audioChunkQueue=[];this.lastVideoTimestamp=0;this.lastAudioTimestamp=0;this.finalized=!1;this.options=e,e.target==="buffer"?this.target=new c:this.target=new f(e.target),this.createFileHeader()}createFileHeader(){this.writeEBMLHeader(),this.createSeekHead(),this.createSegmentInfo(),this.createTracks(),this.createSegment(),this.createCues()}writeEBMLHeader(){let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:"webm"},{id:17031,data:2},{id:17029,data:2}]};this.target.writeEBML(e)}createSeekHead(){let e=new Uint8Array([28,83,187,107]),t=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),r={id:290298740,data:[{id:19899,data:[{id:21419,data:e},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:0}]}]};this.seekHead=r}createSegmentInfo(){let e={id:17545,data:new u(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:"Vani's epic muxer"},{id:22337,data:"Vani's epic muxer"},e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};if(this.tracksElement=e,this.options.video){this.videoCodecPrivate={id:236,size:4,data:new Uint8Array(k)};let t={id:21936,data:[{id:21937,data:2},{id:21946,data:2},{id:21947,data:2},{id:21945,data:0}]};this.colourElement=t,e.data.push({id:174,data:[{id:215,data:m},{id:29637,data:m},{id:131,data:z},{id:134,data:this.options.video.codec},this.videoCodecPrivate,this.options.video.frameRate?{id:2352003,data:1e9/this.options.video.frameRate}:null,{id:224,data:[{id:176,data:this.options.video.width},{id:186,data:this.options.video.height},t]}].filter(Boolean)})}this.options.audio&&(this.audioCodecPrivate={id:236,size:4,data:new Uint8Array(k)},e.data.push({id:174,data:[{id:215,data:b},{id:29637,data:b},{id:131,data:E},{id:134,data:this.options.audio.codec},this.audioCodecPrivate,{id:225,data:[{id:181,data:new l(this.options.audio.sampleRate)},{id:159,data:this.options.audio.numberOfChannels},this.options.audio.bitDepth?{id:25188,data:this.options.audio.bitDepth}:null].filter(Boolean)}]}))}createSegment(){let e={id:408125543,size:5,data:[this.seekHead,this.segmentInfo,this.tracksElement]};this.segment=e,this.target.writeEBML(e)}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return this.target.offsets.get(this.segment)+8}addVideoChunk(e,t){for(this.ensureNotFinalized(),this.lastVideoTimestamp=e.timestamp;this.audioChunkQueue.length>0&&this.audioChunkQueue[0].timestamp<=e.timestamp;){let i=this.audioChunkQueue.shift();this.writeSimpleBlock(i)}if(!this.options.audio||e.timestamp<=this.lastAudioTimestamp?this.writeSimpleBlock(e):this.videoChunkQueue.push(e),t.decoderConfig){if(t.decoderConfig.colorSpace){let i=t.decoderConfig.colorSpace;this.colourElement.data=[{id:21937,data:{rgb:1,bt709:1,bt470bg:5,smpte170m:6}[i.matrix]},{id:21946,data:{bt709:1,smpte170m:6,"iec61966-2-1":13}[i.transfer]},{id:21947,data:{bt709:1,bt470bg:5,smpte170m:6}[i.primaries]},{id:21945,data:[1,2][Number(i.fullRange)]}];let r=this.target.pos;this.target.seek(this.target.offsets.get(this.colourElement)),this.target.writeEBML(this.colourElement),this.target.seek(r)}t.decoderConfig.description&&this.writeCodecPrivate(this.videoCodecPrivate,t.decoderConfig.description)}}addAudioChunk(e,t){for(this.ensureNotFinalized(),this.lastAudioTimestamp=e.timestamp;this.videoChunkQueue.length>0&&this.videoChunkQueue[0].timestamp<=e.timestamp;){let i=this.videoChunkQueue.shift();this.writeSimpleBlock(i)}!this.options.video||e.timestamp<=this.lastVideoTimestamp?this.writeSimpleBlock(e):this.audioChunkQueue.push(e),t.decoderConfig&&this.writeCodecPrivate(this.audioCodecPrivate,t.decoderConfig.description)}writeSimpleBlock(e){let t=Math.floor(e.timestamp/1e3);if(e.type!=="key"&&t-this.currentClusterTimestamp>=C)throw new Error(`Current Matroska cluster exceeded its maximum allowed length of ${C} milliseconds. In order to produce a correct WebM file, you must pass in a video key frame at least every ${C} milliseconds.`);let r=(e instanceof EncodedVideoChunk||!this.options.video)&&e.type==="key"&&t-this.currentClusterTimestamp>=1e3;(!this.currentCluster||r)&&this.createNewCluster(t);let a=new Uint8Array(4),n=new DataView(a.buffer);n.setUint8(0,128|(e instanceof EncodedVideoChunk?m:b)),n.setUint16(1,t-this.currentClusterTimestamp,!1),n.setUint8(3,Number(e.type==="key")<<7);let h=new Uint8Array(e.byteLength);e.copyTo(h);let g={id:163,data:[a,h]};this.target.writeEBML(g),this.duration=Math.max(this.duration,t)}writeCodecPrivate(e,t){let i=this.target.pos;this.target.seek(this.target.offsets.get(e)),e=[{id:25506,size:4,data:new Uint8Array(t)},{id:236,size:4,data:new Uint8Array(k-2-4-t.byteLength)}],this.target.writeEBML(e),this.target.seek(i)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.currentCluster={id:524531317,data:[{id:231,data:e}]},this.target.writeEBML(this.currentCluster),this.currentClusterTimestamp=e;let t=this.target.offsets.get(this.currentCluster)-this.segmentDataOffset;this.cues.data.push({id:187,data:[{id:179,data:e},{id:183,data:[{id:247,data:m},{id:241,data:t}]}]})}finalizeCurrentCluster(){let e=this.target.pos-(this.target.offsets.get(this.currentCluster)+8),t=this.target.pos;this.target.seek(this.target.offsets.get(this.currentCluster)+4),this.target.writeEBMLVarInt(e,4),this.target.seek(t)}finalize(){for(;this.videoChunkQueue.length>0;)this.writeSimpleBlock(this.videoChunkQueue.shift());for(;this.audioChunkQueue.length>0;)this.writeSimpleBlock(this.audioChunkQueue.shift());this.finalizeCurrentCluster(),this.target.writeEBML(this.cues);let e=this.target.pos,t=this.target.pos-this.segmentDataOffset;return this.target.seek(this.target.offsets.get(this.segment)+4),this.target.writeEBMLVarInt(t,4),this.segmentDuration.data=new u(this.duration),this.target.seek(this.target.offsets.get(this.segmentDuration)),this.target.writeEBML(this.segmentDuration),this.seekHead.data[0].data[1].data=this.target.offsets.get(this.cues)-this.segmentDataOffset,this.seekHead.data[1].data[1].data=this.target.offsets.get(this.segmentInfo)-this.segmentDataOffset,this.seekHead.data[2].data[1].data=this.target.offsets.get(this.tracksElement)-this.segmentDataOffset,this.target.seek(this.target.offsets.get(this.seekHead)),this.target.writeEBML(this.seekHead),this.target.seek(e),this.finalized=!0,this.target instanceof c?this.target.finalize():(this.target instanceof f&&this.target.finalize(),null)}ensureNotFinalized(){if(this.finalized)throw new Error("Cannot add new video or audio chunks after the file has been finalized.")}},H=x;return D(R);})();
WebMMuxer = WebMMuxer.default;
if (typeof exports === "object") module.exports = WebMMuxer;
